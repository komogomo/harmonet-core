# HarmoNet 機能要件定義書（v1.2）  
作成日: 2025年10月30日  
最終更新日: 2025年10月30日  
文書管理番号: HARMONET-REQ-001  
文書分類: 要件定義書  
セキュリティレベル: 社外秘  

---

## 第1章 ドキュメント概要

### 1.1 目的
本書は、**HarmoNetアプリケーション**の開発における機能要件および非機能要件を定義し、  
設計・開発・運用の各フェーズにおける共通理解を確立することを目的とする。  

本書はAI協調開発（GPT・Claude・Gemini連携）による開発プロセスを前提としており、  
生成AI間で再利用可能な構造・文体を採用している。  

---

### 1.2 適用範囲
本書はHarmoNetシステム全体を対象とする。対象範囲は以下の通り。

- フロントエンド（React + PWA構成）  
- バックエンド（NestJS + Supabase PostgreSQL）  
- 認証・通知・翻訳を含むアプリケーションサービス群  
- 運用・監視・バックアップを含むインフラ構成（Vercel + Supabase）  

また、将来的なマルチテナント拡張を想定し、tenant_idによるデータ分離方式を採用する。

---

### 1.3 背景と開発体制
HarmoNetは、**地域コミュニティの共助と情報共有**を支援するアプリケーションであり、  
住民・管理組合・管理会社間の情報格差を軽減し、心理的安心感を高めることを目的とする。  

開発は「**AI協調型MVP開発方式**」を採用し、  
要件定義〜実装〜テストまでをAIと人間の共同作業で行う。  

開発体制は以下の通り。

| 区分 | 担当 | 備考 |
|------|------|------|
| プロジェクトオーナー | TKD | 要件定義・レビュー |
| AI開発チーム | GPT（PMO/要件整理）<br>Claude（UI/UXデザイン）<br>Gemini（環境構築・コード整合） | 3AI連携体制 |
| フレームワーク | NestJS + Supabase + React (PWA) | v3.2 Technical Stackに準拠 |

---

### 1.4 関連ドキュメント
本書は以下の関連ドキュメントと整合を取る。

| ドキュメント名 | 概要 |
|----------------|------|
| **HarmoNet Technical Stack Definition v3.2** | 技術基盤・アーキテクチャ仕様 |
| **HarmoNet Design Guidelines v1.1** | UI/UX設計指針 |
| **HarmoNet Database Schema v1.0** | テーブル・ER定義書 |
| **HarmoNet API Specification v1.0** | REST API定義・認証仕様 |
| **HarmoNet Infrastructure Design v1.0** | Vercel + Supabase構成図・監視設計 |
| **HarmoNet UI Basic Design** | 各画面の構成およびコンポーネント構成 |

---

### 1.5 バージョン履歴

| バージョン | 日付 | 概要 | 作成者 |
|-------------|------|------|--------|
| v1.0 | 2025/10/26 | 初版作成 | TKD |
| v1.1 | 2025/10/26 | 掲示板機能改訂（AIモデレーション追加） | TKD |
| **v1.2** | **2025/10/30** | Supabase構成への整合化、RLS・Auth更新 | **GPT署名** |

---

### 1.6 注意事項
本要件定義書は、MVP開発時点での確定要件を示すものであり、  
将来的な拡張（AI連携、IoT連携、マルチテナント化）により改訂される可能性がある。  

本文書の内容はHarmoNet開発チーム内および関係者限定で共有されるものであり、  
**無断複製・再配布を禁ずる。**

---

# 第2章 システム概要（v1.2）

## 2.1 開発目的
HarmoNetは、地域社会の中で「安心・つながり・効率」を実現する**デジタル共助プラットフォーム**である。  
紙や掲示板によるアナログ運用をオンライン化し、管理者と住民の情報格差を減らすことを目的とする。  

主な目的は以下の通り。

- **情報伝達の確実化**：お知らせ・回覧板をデジタル化し、多言語で届ける  
- **共用施設の効率利用**：駐車場や集会所をオンラインで予約・可視化  
- **コミュニティ活性化**：掲示板機能を通じて心理的距離を縮める  
- **管理業務の省力化**：既読状況や通報を自動集計し、報告工数を削減  
- **国際化対応**：日本語・英語・中国語の3言語UIを標準提供  

---

## 2.2 利用対象者

| 区分 | 対象 | 特徴 |
|------|------|------|
| 一般住民 | 日本語話者・外国語話者（英語/中国語圏） | スマートフォン中心の利用想定 |
| 管理者 | 管理組合理事・管理会社担当者 | 情報発信・回覧管理・住民登録 |
| システム管理者 | 運用保守担当 | テナント登録・設定管理（Supabase管理画面） |

---

## 2.3 システム全体構成

### 技術スタック（v3.2準拠）

| レイヤー | 技術 | バージョン | 概要 |
|-----------|------|-------------|------|
| フロントエンド | React (PWA) + Tailwind CSS | 18.x / 3.x | ミニマルで自然なUI、Appleカタログ風トーン |
| バックエンド | NestJS (Node.js) + Prisma ORM | 10.x / 5.x | 型安全・マルチテナント対応API層 |
| データベース | Supabase PostgreSQL + RLS | 15.x | Row-Level Securityでテナント分離 |
| キャッシュ | Redis | 7.x | 翻訳キャッシュ・セッション管理 |
| 認証 | Supabase Auth + NextAuth | - | Magic Link + JWT認証統合 |
| 通知 | SendGrid / FCM | - | メールおよびプッシュ通知 |
| 翻訳 | Google Cloud Translation API (Basic v2) | - | JA/EN/CN自動翻訳対応 |
| ホスティング | Vercel + Supabase | - | 開発・運用コスト最適化構成 |
| バージョン管理 | GitHub + Git Flow | - | AI協調開発での安定ブランチ戦略 |

---

### アーキテクチャ概要

```
[Frontend: React PWA]
   ↓ HTTPS (REST / JSON)
[Backend: NestJS + Prisma]
   ↓
[Database: Supabase PostgreSQL (RLS)]
   ↓
[External Services]
   ├─ Supabase Auth (Magic Link, JWT)
   ├─ Google Translation API
   ├─ SendGrid / Amazon SES
   ├─ Firebase Cloud Messaging (Phase 2)
   └─ Cloudflare CDN (optional)
```

---

### マルチテナント構造（RLS適用）

Supabase PostgreSQLの**Row-Level Security (RLS)**を用い、  
テナント（管理組合単位）ごとにデータを論理分離する。  
各クエリにはJWTに埋め込まれた `tenant_id` が自動適用され、  
他テナントへのアクセスを防止する。

#### 主要テーブル例
| テーブル | 用途 |
|-----------|------|
| tenant | テナント基本情報 |
| tenant_user | ユーザーとテナントの関連付け |
| tenant_settings | カスタム設定（JSON構造） |
| tenant_features | 機能フラグ管理（bbs, parking, consumables等） |

#### RLSポリシー例
```sql
CREATE POLICY tenant_isolation_policy
ON public.bbs_posts
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

---

## 2.4 運用前提

| 項目 | 内容 |
|------|------|
| 対応デバイス | スマートフォン（iOS/Android）、タブレット、PC |
| 対応ブラウザ | Chrome / Safari / Edge / Firefox（最新版） |
| 稼働時間 | 24時間365日（メンテナンス時を除く） |
| 稼働率目標 | 99%以上（Vercel SLA基準） |
| バックアップ | Supabase自動バックアップ（1日1回） |
| 障害監視 | Sentry + UptimeRobot（3分間隔） |
| セキュリティ | TLS1.3通信、AES256暗号化、JWT署名検証 |
| スケーラビリティ | SupabaseプランアップまたはAWS移行で拡張可能 |

---

## 2.5 開発方針

HarmoNetの開発は、**AI協調型アジャイル**を採用する。  
すべての設計資料・ソースコード・仕様書をMarkdown形式で統一し、  
AI同士（GPT・Claude・Gemini）の整合性を自動的に保つ。  

開発フェーズは以下の通り。

| フェーズ | 期間 | 主要成果物 |
|-----------|------|-------------|
| Phase 1 | 〜2026年5月 | MVP（お知らせ・掲示板・駐車場予約・マイページ） |
| Phase 2 | +6ヶ月 | 消耗品管理・FCMプッシュ通知・アンケート機能 |
| Phase 3 | +1年 | AI要約・HEMS連携・多拠点化対応 |
| Phase 4 | +2年 | IoT連携・スマート通知・マルチテナント統合管理 |

---

# 第3章 機能要件（前半）v1.2  
対象範囲：ホーム画面、掲示板機能、お知らせ機能  

---

## 3.1 ホーム画面

### 3.1.1 概要
ログイン後のポータル画面。  
Supabase Authで認証済みのユーザー情報を基に、所属テナント（管理組合）とユーザー設定を読み込み、  
各機能モジュールへナビゲートする。

### 3.1.2 主要要素
| 項目 | 概要 |
|------|------|
| ヘッダー | アプリ名「HarmoNet」、言語切替ボタン（JA/EN/CN）、通知アイコン（未読バッジ） |
| ウェルカムエリア | ログイン中ユーザー名、所属情報（例：A棟105号室） |
| 最新お知らせ | 最新3件表示、未読/既読状態をバッジ表示 |
| 機能タイル | 主要機能ショートカット（3×3グリッド） |
| フッター | グローバルナビゲーション（🏠ホーム、🔔お知らせ、💬掲示板、📅予約、👤マイページ） |

### 3.1.3 機能タイル一覧（MVP）
| 名称 | アイコン | 遷移先 | 備考 |
|------|----------|--------|------|
| 駐車場予約 | 📅 | 施設予約TOP | MVP対象 |
| 回覧板 | 📋 | 回覧板一覧 | MVP対象 |
| 掲示板 | 💬 | 掲示板一覧 | MVP対象 |
| 通知設定 | 🔔 | 設定画面 | MVP対象 |
| 見守り | ❤️ | 安否確認 | Phase 2予定 |
| 消耗品 | 🛒 | 消耗品注文（Consumables） | Phase 2予定 |

---

## 3.2 掲示板機能（BBS）

### 3.2.1 概要
住民同士の交流および管理者からの情報発信を担う主要機能。  
投稿内容はSupabase上でテナントIDにより分離され、RLSによって他テナントからは不可視。  
投稿・返信・削除・翻訳・通報などの機能を持つ。

### 3.2.2 掲示板の種類
| 区分 | 概要 | 権限 |
|------|------|------|
| 全体掲示板 | 全住民が閲覧・投稿可能 | 全ユーザー |
| グループ掲示板 | 班・棟単位の掲示板 | 所属ユーザーのみ |
| 回覧板／重要告知 | 管理者専用の一方向掲示 | 管理者のみ投稿可 |

---

### 3.2.3 投稿機能
- 新規スレッド：タイトル・本文・カテゴリ・画像添付に対応  
- 投稿者：実名または匿名（内部的にuser_id保持）  
- Supabase Storageに画像を保存（RLS制御付与）  

```sql
CREATE POLICY tenant_storage_policy
ON storage.objects
USING (bucket_id = auth.jwt() ->> 'tenant_id');
```

---

### 3.2.4 返信・コメント機能
- 返信階層は1段階まで（ネスト不可）  
- 返信時に通知（メールまたはFCM）を自動送信  
- Supabase Triggerでコメント投稿時に通知イベントを発火  

---

### 3.2.5 AIモデレーション
投稿確定前に、AI（GPTモデル）が本文を解析。  
以下の処理を行う。

| 項目 | 内容 |
|------|------|
| 不適切表現検知 | 攻撃的・差別的・個人情報の自動検出 |
| 修正支援 | 軽度な違反は自動書き換え提案（例：「苦情」→「要望」） |
| 投稿拒否 | 原則行わない（検閲ではなく緩和方式） |
| 管理負担軽減 | 理事・管理会社の介入を最小化 |

---

### 3.2.6 閲覧・翻訳
- 一覧表示：カテゴリ／タグ／コメント件数／翻訳ボタン  
- 詳細表示：本文・画像・コメント時系列表示  
- 翻訳ボタン押下でGoogle Cloud Translation APIを呼び出し、結果をRedisキャッシュ  
- 翻訳結果は多言語キャッシュテーブルに保存し、再翻訳を抑制  

---

### 3.2.7 編集・削除・通報
| 区分 | 操作者 | 機能 |
|------|----------|------|
| 投稿者本人 | 自分の投稿を削除可能（論理削除） |
| 管理者 | 全投稿削除可。削除理由をログに記録 |
| 住民 | 通報ボタンで不適切投稿を報告（通報理由を記録） |

---

### 3.2.8 既読・通知
- 投稿・コメントは、閲覧時に自動で既読登録  
- Supabase Functionで `bbs_read_log` テーブルに記録  
- 回覧板タグ付き投稿は「未読件数」を通知に反映  

---

## 3.3 お知らせ機能（Announcements）

### 3.3.1 概要
管理組合や理事会が住民へ情報を一方向に伝達するための機能。  
Phase 1ではメール通知（SendGrid）を実装、Phase 2でプッシュ通知（FCM）を拡張。

---

### 3.3.2 お知らせ一覧
| 項目 | 概要 |
|------|------|
| カテゴリバッジ | 「重要」「イベント」「メンテナンス」「回覧」など |
| タイトル／本文 | 3言語対応（JA/EN/CN） |
| 検索・絞り込み | カテゴリ／未読・既読／日付範囲／キーワード検索 |

---

### 3.3.3 お知らせ詳細
- タイトル・本文・添付画像（最大5枚）を表示  
- 公開期間・既読状態を表示  
- 「確認済み」ボタンで既読登録  
- 翻訳はAPIまたはキャッシュ利用（掲示板と共通処理）

---

### 3.3.4 管理者による作成
- 入力：タイトル、本文（5000文字以内）、カテゴリ、公開日時、画像添付  
- 翻訳ボタンで自動翻訳（日→英・中）  
- プレビューで住民表示確認  
- 公開後、自動でメール通知（Phase 1）  

---

### 3.3.5 通知処理（Phase対応）
| フェーズ | 通知方式 | 実装概要 |
|-----------|------------|-----------|
| Phase 1 | SendGridメール | Supabase FunctionsからAPI呼出 |
| Phase 2 | Firebase Cloud Messaging | 端末トークン登録 + 多言語本文通知 |

---

### 3.3.6 既読・確認管理
- 管理者画面で既読率／未読者リストを閲覧  
- CSV出力対応  
- Supabase Triggerで既読登録時に自動集計  

---

# 第3章 機能要件（前半）v1.2  
対象範囲：ホーム画面、掲示板機能、お知らせ機能  

---

## 3.1 ホーム画面

### 3.1.1 概要
ログイン後のポータル画面。  
Supabase Authで認証済みのユーザー情報を基に、所属テナント（管理組合）とユーザー設定を読み込み、  
各機能モジュールへナビゲートする。

### 3.1.2 主要要素
| 項目 | 概要 |
|------|------|
| ヘッダー | アプリ名「HarmoNet」、言語切替ボタン（JA/EN/CN）、通知アイコン（未読バッジ） |
| ウェルカムエリア | ログイン中ユーザー名、所属情報（例：A棟105号室） |
| 最新お知らせ | 最新3件表示、未読/既読状態をバッジ表示 |
| 機能タイル | 主要機能ショートカット（3×3グリッド） |
| フッター | グローバルナビゲーション（🏠ホーム、🔔お知らせ、💬掲示板、📅予約、👤マイページ） |

### 3.1.3 機能タイル一覧（MVP）
| 名称 | アイコン | 遷移先 | 備考 |
|------|----------|--------|------|
| 駐車場予約 | 📅 | 施設予約TOP | MVP対象 |
| 回覧板 | 📋 | 回覧板一覧 | MVP対象 |
| 掲示板 | 💬 | 掲示板一覧 | MVP対象 |
| 通知設定 | 🔔 | 設定画面 | MVP対象 |
| 見守り | ❤️ | 安否確認 | Phase 2予定 |
| 消耗品 | 🛒 | 消耗品注文（Consumables） | Phase 2予定 |

---

## 3.2 掲示板機能（BBS）

### 3.2.1 概要
住民同士の交流および管理者からの情報発信を担う主要機能。  
投稿内容はSupabase上でテナントIDにより分離され、RLSによって他テナントからは不可視。  
投稿・返信・削除・翻訳・通報などの機能を持つ。

### 3.2.2 掲示板の種類
| 区分 | 概要 | 権限 |
|------|------|------|
| 全体掲示板 | 全住民が閲覧・投稿可能 | 全ユーザー |
| グループ掲示板 | 班・棟単位の掲示板 | 所属ユーザーのみ |
| 回覧板／重要告知 | 管理者専用の一方向掲示 | 管理者のみ投稿可 |

---

### 3.2.3 投稿機能
- 新規スレッド：タイトル・本文・カテゴリ・画像添付に対応  
- 投稿者：実名または匿名（内部的にuser_id保持）  
- Supabase Storageに画像を保存（RLS制御付与）  

```sql
CREATE POLICY tenant_storage_policy
ON storage.objects
USING (bucket_id = auth.jwt() ->> 'tenant_id');
```

---

### 3.2.4 返信・コメント機能
- 返信階層は1段階まで（ネスト不可）  
- 返信時に通知（メールまたはFCM）を自動送信  
- Supabase Triggerでコメント投稿時に通知イベントを発火  

---

### 3.2.5 AIモデレーション
投稿確定前に、AI（GPTモデル）が本文を解析。  
以下の処理を行う。

| 項目 | 内容 |
|------|------|
| 不適切表現検知 | 攻撃的・差別的・個人情報の自動検出 |
| 修正支援 | 軽度な違反は自動書き換え提案（例：「苦情」→「要望」） |
| 投稿拒否 | 原則行わない（検閲ではなく緩和方式） |
| 管理負担軽減 | 理事・管理会社の介入を最小化 |

---

### 3.2.6 閲覧・翻訳
- 一覧表示：カテゴリ／タグ／コメント件数／翻訳ボタン  
- 詳細表示：本文・画像・コメント時系列表示  
- 翻訳ボタン押下でGoogle Cloud Translation APIを呼び出し、結果をRedisキャッシュ  
- 翻訳結果は多言語キャッシュテーブルに保存し、再翻訳を抑制  

---

### 3.2.7 編集・削除・通報
| 区分 | 操作者 | 機能 |
|------|----------|------|
| 投稿者本人 | 自分の投稿を削除可能（論理削除） |
| 管理者 | 全投稿削除可。削除理由をログに記録 |
| 住民 | 通報ボタンで不適切投稿を報告（通報理由を記録） |

---

### 3.2.8 既読・通知
- 投稿・コメントは、閲覧時に自動で既読登録  
- Supabase Functionで `bbs_read_log` テーブルに記録  
- 回覧板タグ付き投稿は「未読件数」を通知に反映  

---

## 3.3 お知らせ機能（Announcements）

### 3.3.1 概要
管理組合や理事会が住民へ情報を一方向に伝達するための機能。  
Phase 1ではメール通知（SendGrid）を実装、Phase 2でプッシュ通知（FCM）を拡張。

---

### 3.3.2 お知らせ一覧
| 項目 | 概要 |
|------|------|
| カテゴリバッジ | 「重要」「イベント」「メンテナンス」「回覧」など |
| タイトル／本文 | 3言語対応（JA/EN/CN） |
| 検索・絞り込み | カテゴリ／未読・既読／日付範囲／キーワード検索 |

---

### 3.3.3 お知らせ詳細
- タイトル・本文・添付画像（最大5枚）を表示  
- 公開期間・既読状態を表示  
- 「確認済み」ボタンで既読登録  
- 翻訳はAPIまたはキャッシュ利用（掲示板と共通処理）

---

### 3.3.4 管理者による作成
- 入力：タイトル、本文（5000文字以内）、カテゴリ、公開日時、画像添付  
- 翻訳ボタンで自動翻訳（日→英・中）  
- プレビューで住民表示確認  
- 公開後、自動でメール通知（Phase 1）  

---

### 3.3.5 通知処理（Phase対応）
| フェーズ | 通知方式 | 実装概要 |
|-----------|------------|-----------|
| Phase 1 | SendGridメール | Supabase FunctionsからAPI呼出 |
| Phase 2 | Firebase Cloud Messaging | 端末トークン登録 + 多言語本文通知 |

---

### 3.3.6 既読・確認管理
- 管理者画面で既読率／未読者リストを閲覧  
- CSV出力対応  
- Supabase Triggerで既読登録時に自動集計  

---

# 第4章 非機能要件（v1.2）

---

## 4.1 セキュリティ要件

### 4.1.1 認証方式
HarmoNetでは**Supabase Auth**を用いたMagic Link（パスワードレス）認証を採用する。  
すべてのユーザーはテナント単位で識別され、JWTトークンに `tenant_id` / `role` / `lang` を含む。

#### 認証フロー（更新版）
1. ユーザーがメールアドレスを入力し「ログインリンク送信」を押下  
2. SupabaseがMagic Linkメールを送信（SendGrid経由）  
3. ユーザーがリンクを開くと、Supabaseがトークンを検証しJWT発行  
4. JWTにはtenant_idが含まれ、RLSにより該当データのみ参照可能  
5. アプリ側（NestJS）はSupabase SDK経由で認証状態を検証  

```json
{
  "sub": "user-uuid",
  "tenant_id": "tenant-uuid",
  "role": "tenant_admin",
  "lang": "ja",
  "exp": 1735600000
}
```

#### セキュリティ対策
| 項目 | 内容 |
|------|------|
| 認証強度 | UUIDv4トークン＋HTTPS限定 |
| トークン有効期限 | 15分（自動再発行あり） |
| レートリミット | 3リクエスト／分（Supabase設定） |
| 監査ログ | Supabase Auth Audit Logを利用 |
| 管理者強制ログアウト | Supabase APIによりセッション無効化可能 |

---

### 4.1.2 通信暗号化
- すべての通信は **TLS 1.3** により暗号化。  
- HTTPアクセスはVercelで自動リダイレクト。  
- 秘密情報（APIキー・トークン）はVercelおよびSupabaseの環境変数で管理。  
- DB上の個人情報（氏名・メール）はAES-256で暗号化保存。

---

### 4.1.3 データ分離（RLS）
Supabase PostgreSQLの **Row Level Security (RLS)** により、  
各テナント（管理組合）のデータは論理的に分離される。

```sql
CREATE POLICY tenant_isolation_policy
ON public.announcements
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

---

### 4.1.4 鍵管理
| 項目 | 方法 |
|------|------|
| 暗号鍵 | Supabase Secretsで管理 |
| 鍵ローテーション | 年1回またはインシデント時 |
| APIキー管理 | Supabaseサービスロールで限定使用 |
| 署名方式 | HS256署名によるJWT検証 |

---

## 4.2 性能要件

| 項目 | 要件値 | 備考 |
|------|----------|------|
| 初回ページ読み込み時間 | 3秒以内 | PWAキャッシュ利用時 |
| 再訪時読み込み時間 | 1秒以内 | ブラウザキャッシュ・CDN活用 |
| 翻訳処理時間 | 5秒以内（500文字） | Redisキャッシュ利用時 |
| API応答時間 | 2秒以内（95パーセンタイル） | Supabase Edge Function使用 |
| DBクエリ応答時間 | 1秒以内 | Prisma ORM最適化 |
| 同時アクセス | 200ユーザー（MVP）〜500ユーザー | Supabaseスケール対応 |

### 最適化手法
- **画像最適化**（WebP変換＋遅延読み込み）  
- **コード分割**（React Lazy Loading）  
- **CDN配信**（Vercel + Cloudflare）  
- **翻訳キャッシュ**（Redis + Supabaseストア）  
- **Supabase Edge Functions** によるバックエンド処理分散  

---

## 4.3 アクセシビリティ

WCAG 2.1 レベルAAに準拠。  
| 区分 | 要件 |
|------|------|
| 視覚 | コントラスト比4.5:1以上、200%拡大対応 |
| 聴覚 | 音声・動画コンテンツには字幕を付与（将来対応） |
| 操作 | キーボード操作・スクリーンリーダー対応 |
| 理解 | 明確なエラーメッセージと一貫したUI構成 |
| 多言語 | 日本語・英語・中国語対応（右から左言語は非対応） |

---

## 4.4 スケーラビリティ

### 対応戦略
1. **垂直スケール**：Supabaseプランアップグレード  
2. **水平スケール**：AWS ECS + RDSへの移行（フェーズ3以降）  
3. **キャッシュ層**：Redisクラスタによる分散処理  
4. **CDN**：Cloudflareで静的配信最適化  

### ユーザー規模想定
| フェーズ | 規模 | 対応 |
|-----------|------|------|
| MVP | 100ユーザー／単一物件 | Supabase Free Tier |
| Phase 2 | 500ユーザー／複数棟対応 | Supabase Pro Plan |
| Phase 3 | 5,000ユーザー／複数デベロッパー | AWS移行構成 |

---

## 4.5 信頼性・可用性

| 項目 | 要件 |
|------|------|
| 稼働率 | 99%以上（Vercel SLA基準） |
| バックアップ | Supabase自動バックアップ（1日1回、保持7日） |
| 障害検知 | UptimeRobot（3分監視）＋Sentry連携 |
| 復旧手順 | 自動スナップショットからのリストア、再デプロイ |
| デプロイ方式 | GitHub連携によるVercel自動デプロイ（ロールバック対応） |

---

# 第5章 構成管理・環境要件（v1.2）

---

## 5.1 開発環境

### 5.1.1 技術構成
| レイヤー | 技術 | バージョン | 概要 |
|-----------|------|-------------|------|
| バックエンド | NestJS (Node.js) + Prisma ORM | 10.x / 5.x | REST API／RLS対応 |
| フロントエンド | React (PWA) + Tailwind CSS | 18.x / 3.x | ミニマルUI |
| データベース | Supabase PostgreSQL | 15.x | RLS有効／テナント分離 |
| 認証 | Supabase Auth + NextAuth | - | Magic Link + JWT方式 |
| キャッシュ | Redis | 7.x | 翻訳・セッションキャッシュ |
| コンテナ環境 | Docker Desktop + Compose | 24.x / 2.x | 開発統一環境 |
| 開発エディタ | Visual Studio Code | 最新 | GitHub Copilot対応 |

---

### 5.1.2 ローカル開発手順
1. Docker Desktop を起動  
2. プロジェクトをクローン  
   ```bash
   git clone https://github.com/harmonet/harmonet-app.git
   ```
3. `.env` ファイルを設定（Supabase接続情報を記載）  
4. コンテナ起動  
   ```bash
   docker-compose up -d
   ```
5. 初期データ投入  
   ```bash
   npm run migration:run && npm run seed
   ```
6. 開発サーバー起動  
   ```bash
   npm run dev
   ```

---

### 5.1.3 開発規約
- コーディング規約：Airbnb JavaScript Style Guide  
- コミットルール：Conventional Commits  
- ブランチ戦略：Git Flow  
- コードレビュー：Pull Requestによるピアレビュー必須  
- ドキュメント形式：Markdown統一（.md / .txt）  

---

## 5.2 運用環境

### 5.2.1 ホスティング構成（正式採用）
| 層 | サービス | 役割 |
|----|-----------|------|
| フロントエンド | **Vercel** | PWAホスティング・SSL自動更新 |
| バックエンドAPI | **Supabase Edge Functions** | 認証・API・DBアクセス |
| データベース | **Supabase PostgreSQL (RLS)** | データ格納・テナント分離 |
| 認証 | **Supabase Auth** | Magic Link + JWT |
| ストレージ | **Supabase Storage** | 画像・ファイル管理 |
| 通知 | **SendGrid / FCM** | メール通知・プッシュ通知 |
| CDN | **Cloudflare（任意）** | 静的資産配信 |
| モニタリング | **Sentry + UptimeRobot** | 障害検知・稼働監視 |

---

### 5.2.2 デプロイパイプライン
```
[GitHub push]
   ↓
[Vercel Build & Deploy]
   ↓
[Supabase Migration Step (Prisma CI)]
   ↓
[自動HTTPS設定・SSL証明書更新]
```

- GitHub連携により、`main` ブランチへのマージで自動デプロイ。  
- Vercelダッシュボードからロールバック可能。  
- SupabaseマイグレーションはGitHub Actions経由で自動実行。

---

### 5.2.3 環境構成
| 環境 | 用途 | ドメイン | 備考 |
|------|------|----------|------|
| 開発環境 | ローカルDocker環境 | localhost:3000 | テスト用DB使用 |
| ステージング | 検証用 | staging.harmonet.app | Supabase Staging |
| 本番環境 | 住民利用 | app.harmonet.jp | Supabase Production |

---

## 5.3 バックアップ・監視

### 5.3.1 バックアップ設計
| 対象 | 頻度 | 保管期間 | 保管場所 |
|------|------|----------|-----------|
| データベース | 1日1回 | 7日間 | Supabase自動バックアップ |
| ストレージ（画像） | 随時 | 30日間 | Supabase Versioning |
| コードリポジトリ | コミットごと | 永続 | GitHub |
| 翻訳キャッシュ | 毎週初回再生成 | - | Redis再構築 |

リストア手順はSupabaseコンソールからワンクリックで実行可能。

---

### 5.3.2 監視設計
| 監視対象 | ツール | アラート条件 |
|-----------|--------|---------------|
| サーバ稼働 | UptimeRobot | 応答なし3分継続 |
| エラー検知 | Sentry | 例外発生時Slack通知 |
| DB接続数 | Supabase Monitor | 80%以上で警告 |
| Translation API | Google Cloud Console | 月50万文字の80%超で警告 |

---

## 5.4 稼働率・保守体制

| 項目 | 内容 |
|------|------|
| 稼働率目標 | 99%以上（Vercel SLA基準） |
| メンテナンス | 月1回（深夜2:00〜4:00） |
| リリース管理 | Semantic Versioning（例：v1.2.0） |
| 保守担当 | TKD + GPT（自動ドキュメント整合） |

---

# 第6章 制約条件・将来展望（v1.2）

---

## 6.1 開発スコープ制限（MVP）

HarmoNetの初期開発フェーズ（MVP）では、以下の制約を設ける。  
これにより開発リソースを集中させ、早期リリースと安定稼働を優先する。

| 区分 | 制約内容 | 備考 |
|------|-----------|------|
| 決済機能 | アプリ内決済なし | 管理費と合算して後日請求 |
| 対応言語 | 日本語・英語・中国語（簡体字） | 繁体字はPhase 2以降 |
| 予約単位 | 1日単位のみ | 時間単位は将来拡張 |
| 対応施設 | 駐車場のみ | 集会所・ゲストルームは将来追加 |
| 同時接続数 | 約100ユーザー | Supabase Freeプラン運用 |
| 通知方式 | メール通知（SendGrid） | プッシュ通知はPhase 2で導入 |
| テナント構成 | 単一物件 | 複数物件対応はPhase 3以降 |

---

## 6.2 将来拡張（フェーズ別計画）

HarmoNetはフェーズ方式により機能を拡張する。  
各フェーズの追加項目は、既存構成（Vercel + Supabase + React + NestJS）上にモジュールとして実装される。

---

### フェーズ2（MVP完了後6ヶ月以内）
**キーワード：利便性・通知強化・居住支援**

| カテゴリ | 追加機能 | 概要 |
|-----------|------------|------|
| 消耗品管理（Consumables） | 住民が住宅部品（フィルター・電池等）を確認・注文可能 | テーブル構成：`consumables_items` / `consumables_orders` |
| アンケート機能 | 管理組合が住民向けに質問・集計 | 単一選択・複数選択・自由記述 |
| 掃除当番管理 | 当番表の自動生成と通知 | RLSによる班単位管理 |
| プッシュ通知（FCM） | 各種イベントの即時通知 | Firebase Cloud Messaging採用 |
| 翻訳キャッシュ最適化 | Redis + Supabaseに差分保存 | 再翻訳を防止 |

---

### フェーズ3（MVP完了後1年以内）
**キーワード：AI最適化・スマート化・多拠点展開**

| カテゴリ | 追加機能 | 概要 |
|-----------|-----------|------|
| AI要約 | お知らせ・掲示板投稿の要約生成 | GPTベースの自然言語要約 |
| HEMS連携 | エネルギー使用量の可視化 | 外部API連携（電力会社・HEMSデバイス） |
| マルチテナント統合 | 複数マンション・団地を一括管理 | Supabase RLS + テナント管理UI強化 |
| AIチャットボット | よくある質問の自動応答 | OpenAI API連携予定 |
| 翻訳品質向上 | DeepL／GPT翻訳併用 | 高精度翻訳選択機構 |

---

### フェーズ4（MVP完了後2年以内）
**キーワード：IoT・自動化・持続可能性**

| カテゴリ | 追加機能 | 概要 |
|-----------|-----------|------|
| IoTデバイス連携 | スマートロック・温湿度センサー統合 | Supabase Edge経由制御 |
| 異常検知 | 長期間ログインなし／異常アクセスの検知 | AIによるパターン分析 |
| コミュニティ活性 | イベント募集・物品シェア・スキル共有 | UI拡張／管理モジュール |
| データ分析 | 利用統計・予測分析 | Supabase + Metabase連携 |
| サステナビリティ指標 | 電力・参加率可視化 | 環境負荷分析レポート化 |

---

## 6.3 技術的課題と検討事項

| 項目 | 内容 | 対応方針 |
|------|------|-----------|
| 翻訳コスト管理 | Google Translation APIの無料枠50万文字／月 | Redisキャッシュ＋使用量モニタリング |
| Supabase制限 | 無料プランで接続数上限あり | Proプラン移行時にRLS最適化 |
| 通知分散 | SendGridとFCMの二重管理 | 統一通知マネージャー導入予定 |
| データ保護 | EU圏データ利用時のGDPR対応 | Supabaseリージョン選択で対応 |

---

## 6.4 開発ロードマップ概要

| フェーズ | 期間 | 主な成果物 |
|-----------|------|-------------|
| Phase 1 | 〜2026年5月 | MVP（お知らせ・掲示板・予約・マイページ） |
| Phase 2 | 2026年11月 | 消耗品管理・アンケート・プッシュ通知 |
| Phase 3 | 2027年5月 | AI要約・HEMS連携・マルチテナント強化 |
| Phase 4 | 2028年以降 | IoT連携・予測分析・サステナブル指標 |

---

# 第7章 付録・参照資料・リスク管理（v1.2）

---

## 7.1 用語集

| 用語 | 説明 |
|------|------|
| **HarmoNet** | 地域コミュニティ支援アプリ。住民・管理者・管理会社の三者連携を目的とした情報共有基盤。 |
| **MVP（Minimum Viable Product）** | 最小限の機能で市場適合性を検証する開発手法。 |
| **Supabase** | オープンソースのBaaS（Backend as a Service）。PostgreSQL、Auth、Storageを統合提供。 |
| **RLS（Row Level Security）** | PostgreSQLの機能。テナントID単位で行レベルアクセス制御を行う仕組み。 |
| **Magic Link** | メールで送信されたワンクリック認証リンクを利用したパスワードレス認証方式。 |
| **JWT（JSON Web Token）** | 認証情報を署名付きJSON形式で安全に伝達するトークン方式。 |
| **PWA（Progressive Web App）** | Webアプリをネイティブアプリのように動作させる仕組み。 |
| **i18next** | 多言語対応（国際化）ライブラリ。UI翻訳を動的に切り替える。 |
| **Edge Functions** | Supabaseのサーバレス実行環境。低遅延でAPI処理を実行。 |
| **FCM（Firebase Cloud Messaging）** | Googleのプッシュ通知サービス。 |
| **SendGrid** | クラウドメール配信サービス。HarmoNetの通知メールで使用。 |
| **HEMS** | Home Energy Management System。家庭エネルギー管理システム。 |

---

## 7.2 関連ドキュメント

| ドキュメント名 | 概要 | 保管場所 |
|----------------|------|-----------|
| **HarmoNet Technical Stack Definition v3.2** | 技術基盤・アーキテクチャ仕様書 | `/docs/00_architecture/` |
| **HarmoNet UI Design Guidelines v1.1** | 画面デザインおよびスタイル仕様 | `/docs/01_basic_design/` |
| **HarmoNet Database Schema v1.0** | テーブル定義・ER図 | `/docs/02_db_design/` |
| **HarmoNet API Specification v1.0** | REST APIのエンドポイント仕様 | `/docs/03_api_spec/` |
| **HarmoNet Infrastructure Design v1.0** | 運用環境・監視構成 | `/docs/04_infra/` |
| **HarmoNet Function Detail Specs** | 各画面の詳細設計書群 | `/docs/05_features/` |

---

## 7.3 外部サービス・API一覧（v3.2準拠）

| サービス | 用途 | 利用プラン | 備考 |
|-----------|------|--------------|------|
| **Supabase** | 認証・DB・Storage | Free〜Pro | BaaS基盤。RLS・Auth統合。 |
| **SendGrid** | メール通知 | Free（100通/月） | 認証・お知らせ通知に使用。 |
| **Firebase Cloud Messaging (FCM)** | プッシュ通知 | 無料 | Phase 2より導入。 |
| **Google Cloud Translation API (Basic v2)** | 自動翻訳 | 無料枠50万文字/月 | 翻訳キャッシュにより最適化。 |
| **Cloudflare CDN** | 静的配信高速化 | Free | 任意導入。 |
| **UptimeRobot** | 稼働監視 | Free | 3分間隔監視。 |
| **Sentry** | アプリケーションエラー監視 | Free〜Pro | Vercel連携で導入済み。 |

---

## 7.4 リスク管理

| リスク項目 | 発生確率 | 影響度 | 対策 |
|-------------|-----------|---------|------|
| 翻訳API使用量超過 | 低 | 中 | Redisキャッシュ・月次監視で制御 |
| Supabaseサービス停止 | 低 | 高 | 日次バックアップ・フェイルオーバー設計 |
| セキュリティインシデント | 中 | 高 | RLS強制適用・ログ監査・脆弱性診断 |
| 大量アクセスによる遅延 | 低 | 中 | CDNキャッシュ・Edge Function導入 |
| AI出力の誤翻訳 | 中 | 低 | ユーザー手動修正UI・翻訳履歴保持 |
| 開発スケジュール遅延 | 中 | 中 | フェーズ単位リリース・優先度管理 |
| 住民利用率低下 | 中 | 高 | UX改善・説明会・周知キャンペーン |

---

## 7.5 文書承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| プロジェクトオーナー | __________________ | //__ |
| 開発リーダー | __________________ | //__ |

---

## 7.6 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-------------|------|-----------|---------|
| v1.0 | 2025/10/26 | 初版作成 | TKD |
| v1.1 | 2025/10/26 | 掲示板機能（AIモデレーション）追加 | TKD |
| **v1.2** | **2025/10/30** | Supabase／RLS対応、Phase 2〜4拡張反映 | **GPT署名** |

---

### 7.7 注意事項
本書は、HarmoNet開発チームおよび関係者の内部資料であり、  
**無断複製・再配布・外部共有を禁ずる。**

---

*by GPT (HarmoNet PMO AI)*

