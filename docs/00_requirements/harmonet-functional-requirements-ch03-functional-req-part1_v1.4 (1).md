# HarmoNet 機能要件定義書  
## 第3章 Part1 ホーム・掲示板・お知らせ機能  
**Version 1.3 / 2025-10-31**  
**更新履歴**:Versio 1.4 PDFプレビュー仕様追加（閉じるボタン位置明示、誤操作防止）、タグ管理・ルール投稿・原本管理要件反映

本章は **HarmoNet Technical Stack Definition v3.2** に準拠する。  
HarmoNetは Supabase / Prisma / NestJS / React / Tailwind / Redis / Vercel を中核とする  
マルチテナント型SaaS基盤上に構築される。

---

### 3.1 ホーム機能要件

#### 3.1.1 概要
テナント利用者がアプリ起動時に最初にアクセスするダッシュボード画面。  
利用者の行動導線を簡素化し、主要機能（お知らせ・掲示板・施設予約・アンケート等）への遷移を一貫したUIで提供する。

#### 3.1.2 機能一覧
- お知らせ新着一覧（最大5件）
- 掲示板最新投稿一覧（最大5件）
- 通知設定リンク（MVP対象に追加）
- 多言語切替（JA/EN/ZH）
- ログインユーザー情報表示（プロフィール・所属・権限）

#### 3.1.3 通知設定（MVP対象）
ユーザーは通知種別（お知らせ／掲示板／予約／アンケート等）を個別にON/OFFできる。  
設定はユーザープロファイルに紐づき、テナント単位で管理される。  
通知はFirebase Cloud Messaging (FCM) 経由で配信され、Push通知およびメール通知に対応。  

---

### 3.2 掲示板機能要件

#### 3.2.1 概要
テナント内コミュニケーションの中心機能。投稿・返信・いいね・通報を備える。  
テナントRLS（Row Level Security）により、他テナントからは論理的に隔離される。

#### 3.2.2 投稿機能
- 投稿種別：通常投稿、告知投稿（管理者のみ）
- 添付ファイル対応（画像・PDF）
- PDF添付時はPDF.jsによりモーダルプレビュー可能。  
  プレビュー時は画面上部に小さく「閉じる」テキストまたは✕アイコンを表示し、それをタップして閉じる。  
  背景タップでは閉じず、PDFのスクロール操作を優先する。  
  UIトーンはHarmoNet全体の「やさしく・自然・控えめ」スタイルに合わせる。
- AIモデレーション：投稿時に内容を自動スクリーニングし、暴言・個人情報・広告的内容を検出。
- 検出時は投稿者に修正ガイドを提示。
- 通報機能：利用者が不適切投稿を通報可能。

#### 3.2.3 タグ管理（v1.3追加）
- 投稿時に「タグ」を選択可能。タグ例：「重要」「イベント」「防災」「ルール」など。  
- ホーム画面の「重要なお知らせ」セクションは`tag=重要`投稿をサマリ表示し、タップで掲示板詳細画面を`tag=重要`状態で開く。  
- 掲示板詳細画面ではタグバーを表示し、他タグを選択すると通常表示に切り替わる。  
- タグデータは`tags` JSON配列で保持し、検索・フィルタリング可能。  

#### 3.2.4 ルールタグ運用（v1.3追加）
- 掲示板タグに「ルール」を追加。管理組合が設備・マナー・ごみ出しなどのルールをPDFまたは画像形式で投稿可能。  
- 投稿はPDF.jsまたは画像モーダルでプレビュー閲覧可能。  
- 「ルール」タグの投稿は常時掲示可能とし、住民がいつでも参照できる。  

#### 3.2.5 原本管理（v1.3追加）
- 掲示板に投稿されたPDFをHarmoNetシステムが正式原本として保管する。  
- ファイルはテナント単位でSupabase Storageに格納し、署名付きURLによりアクセス制御を行う。  
- 個人PCでの原本保管を不要とし、役員交代時もデータは保持される。  
- 更新時は旧版をアーカイブ化し、履歴管理・バックアップを行う。  
- 管理組合の公式文書庫として運用し、年度ごとのアーカイブ出力にも対応予定。

#### 3.2.6 通報後対応ルール（v1.3更新）
通報後24時間以内に `tenant_admin` が確認・対応を行う。  
対応内容（削除・警告・無効化）はアクションログとして保管し、監査テーブルに記録する。  
AIモデレーション結果と人間による判断履歴を突合可能な形で保持する。

#### 3.2.7 管理者対応範囲（v1.3追加）
- 投稿削除：`tenant_admin` が即時削除可能。削除理由を残す。  
- 通報確認：AIスコアとユーザー通報履歴を参照。  
- 処理責任：初期対応は `tenant_admin`、再発防止策やAIモデル改善要望は `system_admin` が対応。

---

### 3.3 お知らせ機能要件

#### 3.3.1 概要
管理者が全利用者または特定グループに向けて周知事項を配信する機能。  
掲示板と異なり、一方向の情報提供に限定する。

#### 3.3.2 配信機能
- 対象指定：全体／グループ／個人  
- 公開期間設定  
- 既読・未読ステータス管理  
- 通知設定連携（3.1.3参照）

#### 3.3.3 表示機能
- 新着順表示（既読はグレーアウト）  
- アーカイブ参照可能  
- タップで詳細・添付資料閲覧

---

### 3.4 多言語対応・翻訳キャッシュ設計（v1.3更新）

#### 3.4.1 概要
本機能は、UI表示用テキストとユーザー投稿テキストの翻訳を分離して設計する。  

- **UI多言語切替**：画面右上の言語切替ボタンで、静的テキスト（メニュー名・ボタンラベル・固定メッセージ等）のみを即時翻訳。  
- **投稿内容翻訳**：掲示板などの動的コンテンツについては、各投稿下部に小さく「翻訳」ボタンを配置。  
  ボタン押下時に、ユーザのロケール（ブラウザまたはアカウント設定）に基づき翻訳結果を非同期で取得・表示する。  

翻訳処理はバックエンドAPI層で行い、生成結果をRedisキャッシュに保持する。

#### 3.4.2 Redisキャッシュ仕様
- キー構成：`translation:{post_id}:{lang}`  
- TTL：72時間（Phase1）、更新時に再生成  
- Phase2以降では、再翻訳リクエストをキュー管理（Async処理化）し、キャッシュ負荷を軽減。

---

### 3.5 セキュリティ要件補足
- Prisma RLS（Row Level Security）設定により、`tenant_id` ベースでアクセス制御  
- 投稿・通報ログは不可変監査テーブルに保管  
- Cloudflare WAF / reCAPTCHA 併用によりスパム防止  
- AIモデレーション用APIキーは Secrets Manager に格納

---

### 3.6 非機能要件（抜粋）
| 区分 | 要件内容 | 指標値 |
|------|-----------|--------|
| 応答性能 | 掲示板投稿API | < 1.5秒 |
| 同時アクセス | 100ユーザー/テナント | 99% |
| 翻訳キャッシュヒット率 | Redis | > 85% |
| モデレーション遅延 | 投稿完了まで | < 2秒 |

---

### 3.7 補足情報
- 本章で定義された機能は、全て `tenant_id` スコープで動作する。  
- 管理者種別は `tenant_admin` と `system_admin` に明確に区分。  
- AIモデレーション設定は機能フラグ `ai_moderation_enabled` により制御。  
- Phase2以降で投稿カテゴリごとの翻訳優先度設定を追加予定。

---

**（End of Part1）**
