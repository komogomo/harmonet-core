# 掲示板詳細画面 設計書 - 第7章 インタラクション仕様（Interaction Specifications）

**文書ID**: HRM-BOARD-DETAIL-CH07-001  
**バージョン**: v1.0  
**作成日**: 2025年10月29日  
**最終更新**: 2025年10月29日  
**ステータス**: レビュー待ち

---

## 📋 改訂履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|-----------|------|---------|--------|
| v1.0 | 2025-10-29 | 初版作成 | - |

---

## 目次

- [7.1 画面遷移（Screen Transitions）](#71-画面遷移screen-transitions)
- [7.2 翻訳機能の動作（Translation Functionality）](#72-翻訳機能の動作translation-functionality)
- [7.3 画像拡大表示（Lightbox/Image Viewer）](#73-画像拡大表示lightboximage-viewer)
- [7.4 三点メニューの動作（Three-Dot Menu Actions）](#74-三点メニューの動作three-dot-menu-actions)
- [7.5 通報フロー（Report Flow）](#75-通報フローreport-flow)
- [7.6 投稿編集・削除フロー（Edit & Delete Flow）](#76-投稿編集削除フローedit--delete-flow)

---

## 概要

本章では、掲示板詳細画面におけるユーザー操作とシステム応答の詳細仕様を定義します。各インタラクションがどのように動作し、ユーザーにどのようなフィードバックを提供するかを明確化することで、一貫性のある操作体験を実現します。

**設計の基本方針**

- **即座のフィードバック**: ユーザーの操作に対して即座に視覚的フィードバックを提供
- **操作の可逆性**: 重要な操作には確認ダイアログを表示し、誤操作を防止
- **明確な状態表示**: ローディング、成功、エラーの各状態を明確に表示
- **一貫性の確保**: 他画面との操作方法を統一し、学習コストを最小化

---

## 7.1 画面遷移（Screen Transitions）

### 7.1.1 一覧画面からの遷移

**トリガー**
- 掲示板一覧画面で投稿カードをタップ

**動作フロー**
1. 投稿カードにタップフィードバック（背景色変化: `#F9FAFB`）
2. 150ms後に画面遷移開始
3. 右からスライドインアニメーション（300ms）
4. 投稿詳細データの取得開始（ローディング表示）
5. データ取得完了後、コンテンツ表示

**遷移アニメーション仕様**
- **遷移元（一覧画面）**: 左へフェードアウト（300ms、`opacity: 1 → 0.3`、`translateX: 0 → -20px`）
- **遷移先（詳細画面）**: 右からスライドイン（300ms、`opacity: 0 → 1`、`translateX: 100% → 0`）

**パラメータ引き渡し**
- URL: `/board/detail?id={post_id}` または `/board/detail/{post_id}`
- クエリパラメータ: `from=list`（戻る先の識別用）

### 7.1.2 戻るボタンの動作

**トリガー**
- ヘッダー左上の戻るボタンをタップ
- ブラウザバックボタン（PC/Android）
- スワイプバック（iOS）

**動作フロー**
1. 戻るボタンにタップフィードバック（アイコン色変化: `#2563EB` → `#1D4ED8`）
2. 100ms後に画面遷移開始
3. 左へスライドアウトアニメーション（300ms）
4. 一覧画面へ復帰
5. 一覧画面のスクロール位置を復元

**スクロール位置の復元**
- sessionStorageに一覧画面のスクロール位置を保存
- 詳細画面から戻った時に復元
- 保存キー: `board-list-scroll`

### 7.1.3 編集画面への遷移

**トリガー**
- 三点メニューから「編集」を選択（自分の投稿のみ）

**権限チェック**
- 投稿者本人（`post.author_id === currentUser.id`）のみメニューに表示

**動作フロー**
1. 「編集」メニュー項目をタップ
2. メニューを閉じる
3. 200ms後に編集画面へ遷移
4. 右からスライドインアニメーション（300ms）
5. 投稿データを編集フォームに初期値として設定

**遷移先URL**
- `/board/edit?id={post_id}` または `/board/edit/{post_id}`

**初期値の設定**
- タイトル: 既存の投稿タイトル
- 本文: 既存の投稿本文
- カテゴリ: 既存のカテゴリ（変更不可）
- 添付ファイル: 既存の添付ファイル一覧（削除・追加可能）

### 7.1.4 通報画面への遷移

**トリガー**
- 三点メニューから「通報する」を選択

**動作フロー**
1. 「通報する」メニュー項目をタップ
2. メニューを閉じる
3. 確認ダイアログ表示（200ms）
4. 「通報する」ボタンをタップ
5. 通報理由選択画面へ遷移（モーダル表示）

**モーダル表示仕様**
- 背景オーバーレイ: `rgba(0, 0, 0, 0.5)`、z-index: 2000、フェードイン200ms
- モーダルコンテンツ: 画面下部から上へスライドイン300ms、角丸16px

### 7.1.5 履歴管理（ブラウザバック対応）

**設計方針**
- ブラウザの履歴機能を活用し、戻るボタンで正しく前画面に戻れるようにする
- PWAとしても適切に動作するよう、`window.history` APIを使用

**履歴スタックの管理**
- 詳細画面へ遷移時: `window.history.pushState()`で履歴に追加
- ブラウザバック時: `popstate`イベントリスナーで適切に処理

**注意事項**
- モーダル表示（通報画面、画像拡大表示）は履歴に追加しない
- 編集画面への遷移は履歴に追加する

---

## 7.2 翻訳機能の動作（Translation Functionality）

### 7.2.1 翻訳ボタンの配置

**配置場所**
- **投稿本文**: 本文表示エリアの下部、コメントセクションの前
- **各コメント**: 各コメントアイテムの下部

**ボタンデザイン**
- **未翻訳状態**: Globeアイコン + 「翻訳」ラベル
- **翻訳済み状態**: Globeアイコン + 「元の言語に戻す」ラベル、青色背景

**CSS仕様**
- 通常: 背景 `#F9FAFB`、枠線 `#E5E7EB`、文字色 `#6B7280`
- ホバー: 背景 `#F3F4F6`、枠線 `#D1D5DB`
- アクティブ: 背景 `#E5E7EB`
- 翻訳済み: 背景 `#DBEAFE`、枠線 `#93C5FD`、文字色 `#1E40AF`

### 7.2.2 タップ時の動作フロー

**フロー概要**
1. 翻訳ボタンをタップ
2. ボタンをローディング状態に変更（Spinnerアイコン + 「翻訳中...」）
3. バックエンドAPIへ翻訳リクエスト送信（`/api/v1/translation/translate`）
4. 翻訳結果を受信
5. 本文を翻訳結果に置き換え
6. ボタンを「元の言語に戻す」に変更

**ローディング状態の表示**
- ボタンの不透明度: 0.6
- カーソル: `not-allowed`
- Spinnerアイコンを回転アニメーション（1s、linear、infinite）

**APIリクエスト**
- エンドポイント: `POST /api/v1/translation/translate`
- リクエストボディ: `{ post_id, target_language }`
- 認証: Bearer Token

### 7.2.3 翻訳済みラベルの表示

**デザイン仕様**
- Checkアイコン + 「翻訳済み (Translated)」ラベル
- 背景: `#DBEAFE`、文字色: `#1E40AF`
- 角丸: 0.5rem、パディング: 4px 12px
- フォントサイズ: 12px
- 本文の上に配置（margin-bottom: 16px）

**多言語対応**
- 日本語: 「翻訳済み」
- 英語: 「Translated」
- 中国語: 「已翻译」

### 7.2.4 元の言語への戻し方

**動作フロー**
1. 「元の言語に戻す」ボタンをタップ
2. 翻訳済みラベルを削除
3. 本文を元の言語に戻す（保存済みの原文を復元）
4. ボタンを「翻訳」に変更

**実装方式**
- 元の本文を変数に保存しておき、復元時に使用
- サーバーへのリクエストは不要（クライアント側で完結）

### 7.2.5 翻訳エラー時の処理

**エラーケース**
- ネットワークエラー
- APIエラー（500番台）
- 翻訳サービスの上限超過
- タイムアウト

**エラー表示**
- Alertアイコン + 「翻訳に失敗しました。もう一度お試しください。」
- 背景: `#FEE2E2`、枠線: `#FECACA`、文字色: `#991B1B`
- 翻訳ボタンの上に表示
- 3秒後に自動削除

---

## 7.3 画像拡大表示（Lightbox/Image Viewer）

### 7.3.1 添付画像タップ時の動作

**トリガー**
- 投稿詳細エリアの添付画像サムネイルをタップ

**動作フロー**
1. 画像サムネイルにタップフィードバック（スケール: 0.95）
2. 150ms後にライトボックスを表示
3. 背景オーバーレイをフェードイン（200ms）
4. 画像を中央に拡大表示（300ms、ズームインアニメーション）
5. 複数画像がある場合、左右スワイプで切り替え可能

### 7.3.2 ライトボックスの表示仕様

**HTML構造**
- 背景オーバーレイ（`rgba(0, 0, 0, 0.9)`）
- 閉じるボタン（右上、48px×48px、円形）
- 画像表示エリア（最大90%の幅・高さ）
- ナビゲーションボタン（前・次、左右に配置）
- 画像カウンター（下部中央、例: 「1 / 3」）

**z-index管理**
- ライトボックス全体: 3000
- ナビゲーション・カウンター: 3001
- 閉じるボタン: 3002

**アニメーション**
- 背景オーバーレイ: フェードイン200ms
- 画像: ズームイン300ms（scale: 0.8 → 1、opacity: 0 → 1）

### 7.3.3 画像のズーム・スワイプ操作

**ピンチズーム（スマホ）**
- 2本指でピンチイン/アウト
- ズーム範囲: 0.5倍〜3倍
- ズーム中心点: ピンチの中心

**スワイプによる画像切り替え**
- 左スワイプ: 次の画像
- 右スワイプ: 前の画像
- 閾値: 50px以上のスワイプで切り替え
- スワイプ中は画像が横方向に追従

### 7.3.4 複数画像の切り替え

**ナビゲーションボタンによる切り替え**
- 前へボタン（左）: 前の画像を表示
- 次へボタン（右）: 次の画像を表示
- 最初/最後の画像では循環（1枚目 ← 最後の画像、1枚目 → 最後の画像）

**画像カウンターの更新**
- 現在の画像番号 / 総画像数
- 例: 「1 / 3」 → 「2 / 3」

**切り替えアニメーション**
- フェードアウト（150ms）→ 画像切り替え → フェードイン(150ms)

### 7.3.5 閉じる操作

**閉じる方法**
1. 閉じるボタン（×）をタップ
2. 背景オーバーレイをタップ
3. ESCキー（PC）
4. スワイプダウン（スマホ）

**閉じるアニメーション**
- 画像: ズームアウト300ms（scale: 1 → 0.8、opacity: 1 → 0）
- 背景オーバーレイ: フェードアウト200ms

---

## 7.4 三点メニューの動作（Three-Dot Menu Actions）

### 7.4.1 メニューの表示方法

**トリガー**
- ヘッダー右上の三点メニューアイコン（⋮）をタップ

**表示形式**
- **スマホ**: 画面下部からスライドアップするボトムシート
- **PC**: ドロップダウンメニュー（アイコンの下に表示）

**ボトムシートの仕様**
- 背景オーバーレイ: `rgba(0, 0, 0, 0.5)`
- コンテンツ: 画面下部、角丸16px（上のみ）
- アニメーション: 下から上へスライドイン300ms

### 7.4.2 表示される項目の条件分岐

**自分の投稿の場合**
1. 編集
2. 削除
3. 通報（グレーアウト、または非表示）

**他人の投稿の場合**
1. 通報

**回覧板の場合**
- 編集・削除メニューは表示しない（管理者のみ編集可能）

### 7.4.3 各項目選択時の動作

**「編集」選択時**
1. メニューを閉じる
2. 200ms後に編集画面へ遷移
3. 投稿データを編集フォームに設定

**「削除」選択時**
1. メニューを閉じる
2. 確認ダイアログを表示
3. 「削除する」ボタンをタップで削除実行

**「通報」選択時**
1. メニューを閉じる
2. 通報理由選択画面へ遷移（モーダル表示）

### 7.4.4 メニューを閉じる操作

**閉じる方法**
1. メニュー項目を選択（自動的に閉じる）
2. 背景オーバーレイをタップ
3. ESCキー（PC）
4. スワイプダウン（スマホ）

**閉じるアニメーション**
- ボトムシート: 下へスライドアウト300ms
- 背景オーバーレイ: フェードアウト200ms

---

## 7.5 通報フロー（Report Flow）

### 7.5.1 通報ボタンタップ時の確認ダイアログ

**ダイアログ表示**
- タイトル: 「この投稿を通報しますか？」
- メッセージ: 「不適切な内容を管理者に報告します。」
- ボタン: 「キャンセル」「通報する」

**デザイン仕様**
- 背景オーバーレイ: `rgba(0, 0, 0, 0.5)`
- ダイアログ: 中央配置、白背景、角丸16px
- 「通報する」ボタン: 赤色（`#DC2626`）

### 7.5.2 通報理由選択画面への遷移

**表示形式**
- モーダル（ボトムシート形式）
- 画面下部からスライドアップ

**通報理由の選択肢**
1. スパム・宣伝
2. 不適切なコンテンツ
3. 誹謗中傷・ハラスメント
4. 個人情報の漏洩
5. その他（自由記述欄）

**UI仕様**
- ラジオボタン形式
- 各選択肢はタップ領域を大きく（48px以上）
- 「その他」選択時はテキストエリア表示（最大500文字）

### 7.5.3 通報送信時の処理

**送信フロー**
1. 「送信」ボタンをタップ
2. バリデーション（理由が選択されているか確認）
3. ローディング表示（ボタンを無効化）
4. APIリクエスト送信（`POST /api/v1/reports`）
5. 成功時: 完了メッセージ表示
6. エラー時: エラーメッセージ表示

**APIリクエスト**
- エンドポイント: `POST /api/v1/reports`
- リクエストボディ: `{ post_id, reason, description }`
- 認証: Bearer Token

### 7.5.4 通報完了メッセージ

**表示内容**
- Checkアイコン + 「通報を受け付けました」
- 「管理者が確認し、適切に対応いたします。」
- 「OK」ボタン

**デザイン仕様**
- 背景: `#D1FAE5`、枠線: `#86EFAC`、文字色: `#065F46`
- モーダル中央に表示
- 3秒後に自動的に閉じる、または「OK」ボタンで閉じる

### 7.5.5 元の画面への復帰

**復帰動作**
- 通報完了メッセージを閉じた後、投稿詳細画面に戻る
- 通報した投稿は引き続き閲覧可能
- 管理者による対応は非同期で実施

---

## 7.6 投稿編集・削除フロー（Edit & Delete Flow）

### 7.6.1 編集ボタンタップ時の動作

**権限チェック**
- 投稿者本人（`post.author_id === currentUser.id`）のみ編集可能
- 回覧板（管理者投稿）は一般ユーザーは編集不可

**動作フロー**
1. 三点メニューから「編集」を選択
2. メニューを閉じる
3. 編集画面へ遷移
4. 投稿データを編集フォームに設定

### 7.6.2 編集画面での初期値設定

**初期値として設定される項目**
- タイトル: 既存の投稿タイトル
- 本文: 既存の投稿本文
- カテゴリ: 既存のカテゴリ（ドロップダウンで選択済み、変更不可）
- 添付ファイル: 既存の添付ファイルをプレビュー表示（削除可能）

**編集可能な項目**
- タイトル（最大50文字）
- 本文（最大2000文字）
- 添付ファイルの追加・削除

**編集不可の項目**
- カテゴリ（投稿後は変更不可）
- 投稿日時

### 7.6.3 編集保存時の処理

**保存フロー**
1. 「保存」ボタンをタップ
2. バリデーション実行
3. ローディング表示（ボタンを無効化）
4. APIリクエスト送信（`PUT /api/v1/posts/{post_id}`）
5. 成功時: 投稿詳細画面へ戻る、成功メッセージ表示
6. エラー時: エラーメッセージ表示、編集画面に留まる

**バリデーション**
- タイトル: 必須、最大50文字
- 本文: 必須、最大2000文字
- 添付ファイル: 最大5ファイル、合計10MB

**成功メッセージ**
- Checkアイコン + 「投稿を更新しました」
- 緑色の通知バー、3秒後に自動削除

### 7.6.4 削除ボタンタップ時の確認ダイアログ

**ダイアログ表示**
- タイトル: 「この投稿を削除しますか?」
- メッセージ: 「削除すると元に戻せません。本当に削除しますか?」
- ボタン: 「キャンセル」「削除する」

**デザイン仕様**
- 「削除する」ボタン: 赤色（`#DC2626`）
- 重要な操作なので、明確な確認を要求

### 7.6.5 削除確定時の処理

**削除フロー**
1. 「削除する」ボタンをタップ
2. ダイアログを閉じる
3. ローディング表示（全画面オーバーレイ）
4. APIリクエスト送信（`DELETE /api/v1/posts/{post_id}`）
5. 成功時: 掲示板一覧画面へ遷移、削除完了メッセージ表示
6. エラー時: エラーメッセージ表示、投稿詳細画面に留まる

**APIリクエスト**
- エンドポイント: `DELETE /api/v1/posts/{post_id}`
- 認証: Bearer Token
- 論理削除（`deleted_at`フィールドを更新）

**削除完了メッセージ**
- Checkアイコン + 「投稿を削除しました」
- 緑色の通知バー、掲示板一覧画面の上部に表示
- 3秒後に自動削除

### 7.6.6 削除後の画面遷移

**遷移先**
- 掲示板一覧画面（`/board/list`）

**遷移アニメーション**
- 詳細画面: フェードアウト200ms
- 一覧画面: フェードイン200ms

**削除済み投稿の扱い**
- 一覧画面から削除済み投稿を除外
- 削除済み投稿への直接URLアクセスは404エラー

### 7.6.7 権限チェック

**チェック項目**
- 投稿者本人かどうか（`post.author_id === currentUser.id`）
- 管理者権限の有無（管理者はすべての投稿を削除可能）

**権限がない場合**
- 編集・削除メニューを非表示
- APIレベルでも権限チェック（403 Forbiddenを返す）

---

## 📌 章末ナビゲーション

| ← 前の章 | 目次 | 次の章 → |
|---------|------|---------|
| [第6章: コメント入力エリア](board-detail-design-ch06_v1_0.md) | [目次](board-detail-design-ch00-index_v1_0.md) | [第8章: 状態管理とエラーハンドリング](board-detail-design-ch08_v1_0.md) |

---

## 🔗 関連ドキュメント

- `common-header_v1_1.md` - ヘッダー共通仕様（戻るボタン、三点メニュー）
- `common-i18n_v1_0.md` - 翻訳機能の共通仕様
- `common-error-handling.md` - 共通エラーハンドリング
- `harmonet-design-system_v1_0.md` - HarmoNET Design System
- `board-feature-design-ch07_v2_0.md` - 掲示板機能全体の補助機能仕様

---

**Document ID:** HRM-BOARD-DETAIL-CH07-001  
**Status:** レビュー待ち  
**Created:** 2025-10-29  
**Last Updated:** 2025-10-29  
**Approved by:** _未承認_

---

HarmoNET スマートコミュニケーションアプリ  
掲示板詳細画面 設計書 - 第7章 インタラクション仕様
