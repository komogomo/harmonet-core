# HarmoNet 機能要件定義書（v1.3）  
作成日: 2025年10月31日  
最終更新日: 2025年10月31日  
文書管理番号: HARMONET-REQ-001  
文書分類: 要件定義書  
セキュリティレベル: 社外秘  

---

## 第1章 ドキュメント概要

本章は **HarmoNet Technical Stack Definition v3.2** に準拠する。  
HarmoNetは Supabase / Prisma / NestJS / React / Tailwind / Redis / Vercel を中核とする  
マルチテナント型SaaS基盤上に構築される。

### 1.1 目的
本書は、**HarmoNetアプリケーション**の開発における機能要件および非機能要件を定義し、  
設計・開発・運用の各フェーズにおける共通理解を確立することを目的とする。  

本書はAI協調開発（GPT・Claude・Gemini連携）による開発プロセスを前提としており、  
生成AI間で再利用可能な構造・文体を採用している。  

---

### 1.2 適用範囲
本書はHarmoNetシステム全体を対象とする。対象範囲は以下の通り。

- フロントエンド（React + PWA構成）  
- バックエンド（NestJS v10.x + Supabase PostgreSQL, Node.js LTS v20.x対応）  
- 認証・通知・翻訳を含むアプリケーションサービス群  
- 運用・監視・バックアップを含むインフラ構成（Vercel + Supabase）  

また、将来的なマルチテナント拡張を想定し、tenant_idによるデータ分離方式を採用する。

---

### 1.3 背景と開発体制
HarmoNetは、**地域コミュニティの共助と情報共有**を支援するアプリケーションであり、  
住民・管理組合・管理会社間の情報格差を軽減し、心理的安心感を高めることを目的とする。  

開発は「**AI協調型MVP開発方式**」を採用し、  
要件定義〜実装〜テストまでをAIと人間の共同作業で行う。  

開発体制は以下の通り。

| 区分 | 担当 | 備考 |
|------|------|------|
| プロジェクトオーナー | TKD | 要件定義・レビュー |
| AI開発チーム | GPT（PMO/要件整理）<br>Claude（UI/UXデザイン）<br>Gemini（環境構築・コード整合） | 3AI連携体制 |
| フレームワーク | NestJS v10.x + Supabase + React (PWA) | v3.2 Technical Stackに準拠 |

---

### 1.4 関連ドキュメント
本書は以下の関連ドキュメントと整合を取る。

| ドキュメント名 | 概要 |
|----------------|------|
| **HarmoNet Technical Stack Definition v3.2** | 技術基盤・アーキテクチャ仕様 |
| **HarmoNet Design Guidelines v1.1** | UI/UX設計指針 |
| **HarmoNet Database Schema v1.0** | テーブル・ER定義書 |
| **HarmoNet API Specification v1.0** | REST API定義・認証仕様 |
| **HarmoNet Infrastructure Design v1.0** | Vercel + Supabase構成図・監視設計 |
| **HarmoNet UI Basic Design** | 各画面の構成およびコンポーネント構成 |
| **HarmoNet Functional Requirements v1.3** | 本書。要件定義最新版 |

---

### 1.5 バージョン履歴

| バージョン | 日付 | 概要 | 作成者 |
|-------------|------|------|--------|
| v1.0 | 2025/10/26 | 初版作成 | TKD |
| v1.1 | 2025/10/26 | 掲示板機能改訂（AIモデレーション追加） | TKD |
| v1.2 | 2025/10/30 | Supabase構成への整合化、RLS・Auth更新 | GPT署名 |
| **v1.3** | **2025/10/31** | Geminiレビュー反映：Node.js LTS対応、AI体制定義明文化 | **GPT署名** |

---

### 1.6 注意事項
本要件定義書は、MVP開発時点での確定要件を示すものであり、  
将来的な拡張（AI連携、IoT連携、マルチテナント化）により改訂される可能性がある。  

本文書の内容はHarmoNet開発チーム内および関係者限定で共有されるものであり、  
**無断複製・再配布を禁ずる。**

---

# 第2章 システム概要（v1.3）

## 2.1 開発目的
HarmoNetは、地域社会の中で「安心・つながり・効率」を実現する**デジタル共助プラットフォーム**である。  
紙や掲示板によるアナログ運用をオンライン化し、管理者と住民の情報格差を減らすことを目的とする。  

主な目的は以下の通り。

- **情報伝達の確実化**：お知らせ・回覧板をデジタル化し、多言語で届ける  
- **共用施設の効率利用**：駐車場や集会所をオンラインで予約・可視化  
- **コミュニティ活性化**：掲示板機能を通じて心理的距離を縮める  
- **管理業務の省力化**：既読状況や通報を自動集計し、報告工数を削減  
- **国際化対応**：日本語・英語・中国語の3言語UIを標準提供  

---

## 2.2 利用対象者

| 区分 | 対象 | 特徴 |
|------|------|------|
| 一般住民 | 日本語話者・外国語話者（英語/中国語圏） | スマートフォン中心の利用想定 |
| 管理者 | 管理組合理事・管理会社担当者 | 情報発信・回覧管理・住民登録 |
| システム管理者 | 運用保守担当 | テナント登録・設定管理（Supabase管理画面） |

---

## 2.3 システム全体構成

### 技術スタック（v3.2準拠）

| レイヤー | 技術 | バージョン | 概要 |
|-----------|------|-------------|------|
| フロントエンド | React (PWA) + Tailwind CSS | 18.x / 3.x | ミニマルで自然なUI、Appleカタログ風トーン |
| バックエンド | NestJS v10.x（Node.js LTS v20.x対応） + Prisma ORM | 10.x / 5.x | 型安全・マルチテナント対応API層 |
| データベース | Supabase PostgreSQL + RLS | 15.x | Row-Level Securityでテナント分離 |
| キャッシュ | Redis | 7.x | 翻訳キャッシュ・セッション管理 |
| 認証 | Supabase Auth + NextAuth | - | Magic Link + JWT認証統合 |
| 通知 | SendGrid / FCM | - | メールおよびプッシュ通知 |
| 翻訳 | Google Cloud Translation API (Basic v2) | - | JA/EN/CN自動翻訳対応 |
| ホスティング | Vercel + Supabase | - | 開発・運用コスト最適化構成 |
| バージョン管理 | GitHub + Git Flow | - | AI協調開発での安定ブランチ戦略 |

---

### アーキテクチャ概要

```
[Frontend: React PWA]
   ↓ HTTPS (REST / JSON)
[Backend: NestJS + Prisma]
   ↓
[Database: Supabase PostgreSQL (RLS)]
   ↓
[External Services]
   ├─ Supabase Auth (Magic Link, JWT)
   ├─ Google Translation API
   ├─ SendGrid / Amazon SES
   ├─ Firebase Cloud Messaging (Phase 2)
   └─ Cloudflare CDN (optional)
```

---

### マルチテナント構造（RLS適用）

Supabase PostgreSQLの**Row-Level Security (RLS)**を用い、  
テナント（管理組合単位）ごとにデータを論理分離する。  
各クエリにはJWTに埋め込まれた `tenant_id` が自動適用され、  
他テナントへのアクセスを防止する。

#### 主要テーブル例
| テーブル | 用途 |
|-----------|------|
| tenant | テナント基本情報 |
| tenant_user | ユーザーとテナントの関連付け |
| tenant_settings | カスタム設定（JSON構造） |
| tenant_features | 機能フラグ管理（bbs, parking, consumables等） |

#### RLSポリシー例
```sql
CREATE POLICY tenant_isolation_policy
ON public.bbs_posts
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

---

## 2.4 運用前提

| 項目 | 内容 |
|------|------|
| 対応デバイス | スマートフォン（iOS/Android）、タブレット、PC |
| 対応ブラウザ | Chrome / Safari / Edge / Firefox（最新版） |
| 稼働時間 | 24時間365日（メンテナンス時を除く） |
| 稼働率目標 | 99%以上（Vercel SLA基準） |
| バックアップ | Supabase自動バックアップ（1日1回） |
| 障害監視 | Sentry + UptimeRobot（3分間隔） |
| セキュリティ | TLS1.3通信、AES256暗号化、JWT署名検証、RLS適用によるデータ分離 |
| スケーラビリティ | SupabaseプランアップまたはAWS移行で拡張可能 |

---

## 2.5 開発方針

HarmoNetの開発は、**AI協調型アジャイル**を採用する。  
すべての設計資料・ソースコード・仕様書をMarkdown形式で統一し、  
AI同士（GPT・Claude・Gemini）の整合性を自動的に保つ。  

開発フェーズは以下の通り。

| フェーズ | 期間 | 主要成果物 |
|-----------|------|-------------|
| Phase 1 | 〜2026年5月 | MVP（お知らせ・掲示板・駐車場予約・マイページ・通知設定） |
| Phase 2 | +6ヶ月 | 消耗品管理・FCMプッシュ通知・アンケート機能 |
| Phase 3 | +1年 | AI要約・HEMS連携・多拠点化対応 |
| Phase 4 | +2年 | IoT連携・スマート通知・マルチテナント統合管理 |

---

### AI協調開発体制（追記）

| 役割 | 担当AI | 主な責務 |
|------|---------|-----------|
| UI/UX設計 | Claude | 画面構造・設計レビュー |
| 環境構築／アーキテクチャ | Gemini | インフラ／バックエンド環境設計 |
| ドキュメント統合／整合 | GPT | 要件定義・設計ドキュメント統合、バージョン管理 |

---

---

### 3.1 ホーム機能要件

#### 3.1.1 概要
テナント利用者がアプリ起動時に最初にアクセスするダッシュボード画面。  
利用者の行動導線を簡素化し、主要機能（お知らせ・掲示板・施設予約・アンケート等）への遷移を一貫したUIで提供する。

#### 3.1.2 機能一覧
- お知らせ新着一覧（最大5件）
- 掲示板最新投稿一覧（最大5件）
- 通知設定リンク（MVP対象に追加）
- 多言語切替（JA/EN/ZH）
- ログインユーザー情報表示（プロフィール・所属・権限）

#### 3.1.3 通知設定（MVP対象）
ユーザーは通知種別（お知らせ／掲示板／予約／アンケート等）を個別にON/OFFできる。  
設定はユーザープロファイルに紐づき、テナント単位で管理される。  
通知はFirebase Cloud Messaging (FCM) 経由で配信され、Push通知およびメール通知に対応。  

---

### 3.2 掲示板機能要件

#### 3.2.1 概要
テナント内コミュニケーションの中心機能。投稿・返信・いいね・通報を備える。  
テナントRLS（Row Level Security）により、他テナントからは論理的に隔離される。

#### 3.2.2 投稿機能
- 投稿種別：通常投稿、告知投稿（管理者のみ）
- 添付ファイル対応（画像・PDF）
- AIモデレーション：投稿時に内容を自動スクリーニングし、暴言・個人情報・広告的内容を検出。
- 検出時は投稿者に修正ガイドを提示。
- 通報機能：利用者が不適切投稿を通報可能。

#### 3.2.3 通報後対応ルール（v1.3更新）
通報後24時間以内に `tenant_admin` が確認・対応を行う。  
対応内容（削除・警告・無効化）はアクションログとして保管し、監査テーブルに記録する。  
AIモデレーション結果と人間による判断履歴を突合可能な形で保持する。

#### 3.2.4 管理者対応範囲（v1.3追加）
- 投稿削除：`tenant_admin` が即時削除可能。削除理由を残す。
- 通報確認：AIスコアとユーザー通報履歴を参照。
- 処理責任：初期対応は `tenant_admin`、再発防止策やAIモデル改善要望は `system_admin` が対応。

---

### 3.3 お知らせ機能要件

#### 3.3.1 概要
管理者が全利用者または特定グループに向けて周知事項を配信する機能。  
掲示板と異なり、一方向の情報提供に限定する。

#### 3.3.2 配信機能
- 対象指定：全体／グループ／個人
- 公開期間設定
- 既読・未読ステータス管理
- 通知設定連携（3.1.3参照）

#### 3.3.3 表示機能
- 新着順表示（既読はグレーアウト）
- アーカイブ参照可能
- タップで詳細・添付資料閲覧

---

### 3.4 多言語対応・翻訳キャッシュ設計（v1.3更新）

#### 3.4.1 概要
本機能は、UI表示用テキストとユーザー投稿テキストの翻訳を分離して設計する。  

- **UI多言語切替**：画面右上の言語切替ボタンで、静的テキスト（メニュー名・ボタンラベル・固定メッセージ等）のみを即時翻訳。  
- **投稿内容翻訳**：掲示板などの動的コンテンツについては、各投稿下部に小さく「翻訳」ボタンを配置。  
  ボタン押下時に、ユーザのロケール（ブラウザまたはアカウント設定）に基づき翻訳結果を非同期で取得・表示する。  

翻訳処理はバックエンドAPI層で行い、生成結果をRedisキャッシュに保持する。

#### 3.4.2 Redisキャッシュ仕様
- キー構成：`translation:{post_id}:{lang}`
- TTL：72時間（Phase1）、更新時に再生成
- Phase2以降では、再翻訳リクエストをキュー管理（Async処理化）し、キャッシュ負荷を軽減。

---

### 3.5 セキュリティ要件補足
- Prisma RLS（Row Level Security）設定により、`tenant_id` ベースでアクセス制御
- 投稿・通報ログは不可変監査テーブルに保管
- Cloudflare WAF / reCAPTCHA 併用によりスパム防止
- AIモデレーション用APIキーは Secrets Manager に格納

---

### 3.6 非機能要件（抜粋）
| 区分 | 要件内容 | 指標値 |
|------|-----------|--------|
| 応答性能 | 掲示板投稿API | < 1.5秒 |
| 同時アクセス | 100ユーザー/テナント | 99% |
| 翻訳キャッシュヒット率 | Redis | > 85% |
| モデレーション遅延 | 投稿完了まで | < 2秒 |

---

### 3.7 補足情報
- 本章で定義された機能は、全て `tenant_id` スコープで動作する。
- 管理者種別は `tenant_admin` と `system_admin` に明確に区分。
- AIモデレーション設定は機能フラグ `ai_moderation_enabled` により制御。
- Phase2以降で投稿カテゴリごとの翻訳優先度設定を追加予定。

---

---

## 3.4 施設予約（Facility Reservation）

### 3.4.1 概要
共用施設（駐車場・集会所など）の予約をオンラインで行う機能。  
本機能は初期リリース時点から**マルチテナント対応設計**とし、施設情報（施設名・施設数・駐車場台数・区画番号ルール・駐車場MAP等）はテナント単位で独立管理される。  
MVPでは「ゲスト用駐車場」を初期対象とし、他施設への適用はテナント設定により柔軟に拡張可能。

---

### 3.4.2 予約ルール（MVP: 駐車場）

| 項目 | 内容 |
|------|------|
| 対象台数 | テナント毎に異なる。例：12台（表F1〜F6、裏B1〜B6）など、管理画面で定義可能。 |
| 利用料金 | テナント毎に設定可能（無料／有料、金額単位を含む）。初期値：1日100円（後日請求）。 |
| 予約単位 | 1日単位（時間単位予約なし）。 |
| 予約期間 | 当日〜翌月末まで（デフォルト）。テナント設定により調整可能。 |
| 最大連続予約 | デフォルト3日間。テナント管理者が管理画面から変更可能。 |
| 決済方法 | アプリ内決済は未実装（Phase 2で導入予定）。テナント単位で有効化可能とする設計。 |

---

### 3.4.3 予約フロー

1. カレンダー画面で希望日を選択  
2. MAP表示で空き区画を確認（色分け：青=空、灰=予約済、緑=自分）  
3. 駐車場所を選択 → 予約確認ダイアログ表示  
4. 「予約を確定する」押下でSupabase Functionを呼び出し、  
　排他チェック・保存・通知送信を同時実行  

```sql
-- Supabase Function (Simplified)
BEGIN;
  SELECT * FROM parking_reservations
    WHERE date = $1 AND slot = $2 AND tenant_id = current_setting('app.tenant_id')
    FOR UPDATE;
  INSERT INTO parking_reservations (...);
COMMIT;
```

5. 予約確定後に自動メール通知（SendGrid）  
6. Phase 2でFCMプッシュ通知も送信予定（マイページ設定で制御）

---

### 3.4.4 通知仕様
| イベント | 通知内容 | 配信方式 |
|-----------|------------|------------|
| 予約確定 | 駐車場番号・日付・料金 | SendGridメール（Phase 1） |
| 予約キャンセル | キャンセル確認通知 | SendGridメール |
| リマインダー | 前日18時に通知 | FCMプッシュ（Phase 2） |

通知ON/OFFはマイページの「通知設定」で一元管理される。

---

### 3.4.5 管理者機能
| 機能 | 内容 |
|------|------|
| 予約状況確認 | 全区画をカレンダー形式で表示 |
| 代理予約 | 管理者が住民に代わって予約可能 |
| 予約ブロック設定 | 特定日を予約不可に設定（メンテナンス時） |
| 統計レポート | 月別稼働率／人気区画CSV出力（将来） |

---

## 3.5 マイページ（My Page）

### 3.5.1 概要
住民が自身の情報・設定・履歴を管理する画面。  
Supabase Authから取得したユーザー情報を基に動的描画される。  
通知設定や言語設定などの共通情報を一元管理する中核機能。

---

### 3.5.2 主な機能一覧
| カテゴリ | 機能概要 | 備考 |
|-----------|------------|------|
| プロフィール設定 | 氏名・メール・言語設定の変更 | 言語はJA/EN/ZH |
| 通知設定 | メール／プッシュ通知のON/OFF | 機能別設定可能（掲示板／お知らせ／予約） |
| 掲示板投稿履歴 | 自身の投稿・コメント履歴参照 | 編集／削除可 |
| 予約履歴 | 駐車場予約履歴の閲覧・キャンセル | 未来／過去区別表示 |
| 当番表（将来） | 清掃当番スケジュール表示 | Phase 3予定 |
| 管理者設定 | 管理者のみ表示（ユーザー登録・カテゴリ設定） | tenant_adminロール限定 |

---

### 3.5.3 管理者専用機能
- **ユーザー登録**：Supabase Auth連携。メールアドレス重複チェック。  
- **一括登録**：CSVインポート（氏名, メール, 言語, 権限）  
- **削除**：論理削除フラグで無効化。  
- **権限管理**：`role` クレームで権限判定（member / tenant_admin / system_admin）  

---

## 3.6 共通機能（Global Features）

### 3.6.1 ヘッダー
- 左：アプリロゴ「HarmoNet」  
- 右：通知アイコン + 言語切替ボタン  
- 言語切替は **静的テキストのみ** 即時反映（i18next利用）  
- 投稿やコメントなどの動的データは、個別翻訳ボタンで処理  
- デザインガイドライン準拠：白基調・角丸2xl・BIZ UDゴシック・最小限シャドウ  

```sql
translation_master
- key (varchar)
- ja_text
- en_text
- zh_text
- updated_at
```

---

### 3.6.2 フッター
固定ナビゲーションとして以下のショートカットを配置。  

| アイコン | ラベル | 遷移先 |
|----------|---------|--------|
| 🏠 | ホーム | ホーム画面 |
| 🔔 | お知らせ | お知らせ一覧 |
| 💬 | 掲示板 | 掲示板一覧 |
| 📅 | 予約 | 駐車場予約TOP |
| 👤 | マイページ | マイページ |

アクティブ状態は青ハイライト。  
ログアウトはSupabase Authセッション削除で実装。

---

### 3.6.3 多言語対応（v1.3統一仕様）
- 静的UI：翻訳マスタ（i18next）で即時切替。  
- 動的コンテンツ：各投稿やお知らせ本文下部に「翻訳」ボタンを配置し、押下時にユーザロケールで翻訳表示。  
- 翻訳結果はRedisキャッシュに保持（キー：`translation:{post_id}:{lang}`）。  
- 翻訳履歴をSupabase内に保存し、再翻訳を防止。  

---

### 3.6.4 セッション管理
- Supabase JWTをHTTPOnly Cookieで管理。  
- 有効期限15分／自動更新あり。  
- 管理者によるセッション失効APIを提供。

---

### 3.6.5 通知共通基盤
| 要素 | 概要 |
|------|------|
| メール送信 | SendGrid（Phase 1） |
| プッシュ通知 | Firebase Cloud Messaging（Phase 2） |
| 多言語制御 | i18nextで件名・本文を多言語生成 |
| 配信設定 | ユーザー単位でON/OFF制御（マイページ設定連携） |

**Phase 2通知対象（FCM）**  
- 掲示板：通報対応結果、重要投稿通知  
- お知らせ：新規配信通知  
- 施設予約：リマインダー・キャンセル通知  

---

### 3.6.6 非機能要件補足
| 区分 | 要件内容 | 指標値 |
|------|-----------|--------|
| レイテンシ | 通知配信API応答 | < 1秒 |
| 翻訳キャッシュヒット率 | Redis | > 85% |
| UI応答速度 | ヘッダー／フッター共通部品 | < 0.5秒 |
| モバイル互換性 | iOS / Android | Safari, Chrome最新安定版 |

---


---

## 4.1 セキュリティ要件

### 4.1.1 認証方式
Supabase Auth による Magic Link（パスワードレス）認証を採用。  
ユーザーはテナント単位で識別され、JWTトークンに `tenant_id` / `role` / `lang` を含む。

#### 認証フロー
1. ユーザーがメールアドレスを入力し「ログインリンク送信」を押下  
2. SupabaseがMagic Linkメールを送信（SendGrid経由）  
3. ユーザーがリンクを開くと、Supabaseがトークンを検証しJWT発行  
4. JWTにはtenant_idが含まれ、RLSにより該当テナントデータのみ参照可能  
5. NestJSサーバ側ではSupabase SDKで検証し、Prismaミドルウェアがtenant_idを注入  

```json
{
  "sub": "user-uuid",
  "tenant_id": "tenant-uuid",
  "role": "tenant_admin",
  "lang": "ja",
  "exp": 1735600000
}
```

#### セキュリティ対策
| 項目 | 内容 |
|------|------|
| 認証強度 | UUIDv4トークン＋HTTPS限定 |
| トークン有効期限 | 15分（自動再発行あり） |
| レートリミット | 3リクエスト／分（Supabase設定） |
| 監査ログ | Supabase Auth Audit Logを利用 |
| 管理者強制ログアウト | Supabase APIによりセッション無効化可能 |

---

### 4.1.2 通信暗号化
- 全通信は **TLS 1.3** により暗号化。  
- HTTPアクセスはVercelでHTTPSへ自動リダイレクト。  
- 秘密情報（APIキー・トークン）はVercelおよびSupabaseのSecretsで管理。  
- DB上の個人情報（氏名・メール等）はAES-256で暗号化保存。  

---

### 4.1.3 データ分離（RLS）
Supabase PostgreSQLの **Row Level Security (RLS)** により、  
各テナント（管理組合）のデータを論理的に分離する。

```sql
CREATE POLICY tenant_isolation_policy
ON public.announcements
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

施設設定・駐車場データ・翻訳キャッシュなどもすべて `tenant_id` スコープで保持され、  
物理的スキーマ分離を行わずとも完全なデータ独立性を担保する。

---

### 4.1.4 鍵管理
| 項目 | 方法 |
|------|------|
| 暗号鍵 | Supabase Secretsで管理 |
| 鍵ローテーション | 年1回またはインシデント時 |
| APIキー管理 | Supabaseサービスロールで限定使用 |
| JWT署名方式 | HS256署名による検証 |

---

## 4.2 性能要件

| 項目 | 要件値 | 備考 |
|------|----------|------|
| 初回ページ読み込み時間 | 3秒以内 | PWAキャッシュ利用時 |
| 再訪時読み込み時間 | 1秒以内 | ブラウザキャッシュ・CDN利用 |
| 翻訳処理時間 | 5秒以内（500文字） | Redisキャッシュ利用 |
| API応答時間 | 2秒以内（95パーセンタイル） | Supabase Edge Function使用 |
| DBクエリ応答時間 | 1秒以内 | Prisma ORM最適化 |
| 同時アクセス | 200ユーザー（MVP）〜500ユーザー | Supabaseスケール対応 |

### 最適化手法
- **画像最適化**（WebP変換＋遅延読み込み）  
- **コード分割**（React Lazy Loading）  
- **CDN配信**（Vercel + Cloudflare）  
- **翻訳キャッシュ**（Redisキー：`translation:{post_id}:{lang}`）  
- **Supabase Edge Functions** による処理分散  

---

## 4.3 アクセシビリティ

WCAG 2.1 レベルAAに準拠。  
UIは「HarmoNet Design Guidelines」に従い、BIZ UDゴシックを基調とする。

| 区分 | 要件 |
|------|------|
| 視覚 | コントラスト比4.5:1以上、200%拡大対応 |
| 聴覚 | 音声・動画コンテンツには字幕付与（Phase 3対応） |
| 操作 | キーボード操作・スクリーンリーダー対応 |
| 理解 | 明確なエラーメッセージと一貫したUI構成 |
| 多言語 | 日本語・英語・中国語対応。切替時もARIA属性を維持。 |

---

## 4.4 スケーラビリティ

### 対応戦略
1. **垂直スケール**：Supabaseプランアップグレードによる拡張  
2. **水平スケール**：AWS ECS + RDS移行（Phase 3以降）  
3. **キャッシュ層**：Redisクラスタによる翻訳・セッション分散処理  
4. **テナントスケーリング**：tenant_id単位で独立管理し、バックアップ・負荷分散を容易化  
5. **CDN最適化**：Cloudflareを利用した静的配信最適化  

### ユーザー規模想定
| フェーズ | 規模 | 対応 |
|-----------|------|------|
| MVP | 100ユーザー／単一物件 | Supabase Free Tier |
| Phase 2 | 500ユーザー／複数棟対応 | Supabase Pro Plan |
| Phase 3 | 5,000ユーザー／複数開発会社対応 | AWS移行構成 |

---

## 4.5 信頼性・可用性

| 項目 | 要件 |
|------|------|
| 稼働率 | 99%以上（Vercel SLA基準） |
| バックアップ | Supabase自動バックアップ（1日1回、保持7日） |
| バックアップ対象 | テナント設定・施設情報・翻訳履歴・予約データ含む |
| 障害検知 | UptimeRobot（3分監視）＋Sentry連携 |
| 復旧手順 | 自動スナップショットからのリストア＋再デプロイ |
| デプロイ方式 | GitHub連携によるVercel自動デプロイ（ロールバック対応） |

---

# 第5章 構成管理・環境要件（v1.3）

---

## 5.1 開発環境

### 5.1.1 技術構成
| レイヤー | 技術 | バージョン | 概要 |
|-----------|------|-------------|------|
| バックエンド | NestJS (Node.js) + Prisma ORM | 10.x / 5.x | REST API／RLS対応 |
| フロントエンド | React (PWA) + Tailwind CSS | 18.x / 3.x | AppleカタログトーンのミニマルUI |
| データベース | Supabase PostgreSQL | 15.x | RLS有効／テナント分離 |
| 認証 | Supabase Auth + NextAuth | - | Magic Link + JWT方式 |
| キャッシュ | Redis | 7.x | 翻訳・セッションキャッシュ |
| コンテナ環境 | Docker Desktop + Compose | 24.x / 2.x | 開発統一環境 |
| 開発エディタ | Visual Studio Code | 最新 | GitHub Copilot／AI連携対応 |

---

### 5.1.2 ローカル開発手順
1. Docker Desktop を起動  
2. プロジェクトをクローン  
   ```bash
   git clone https://github.com/harmonet/harmonet-app.git
   ```
3. `.env` ファイルを設定（Supabase接続情報、Redis設定を記載）  
4. コンテナ起動  
   ```bash
   docker-compose up -d
   ```
5. 初期データ投入  
   ```bash
   npm run migration:run && npm run seed
   ```
6. 開発サーバー起動  
   ```bash
   npm run dev
   ```

---

### 5.1.3 開発規約
- コーディング規約：Airbnb JavaScript Style Guide  
- コミットルール：Conventional Commits  
- ブランチ戦略：Git Flow（main／develop／feature）  
- コードレビュー：Pull Requestによるピアレビュー必須  
- ドキュメント形式：Markdown（.md）またはテキスト（.txt）統一  
- 設計／要件書：GPT署名付き出力、HarmoNet共通フォーマットに準拠  

---

## 5.2 運用環境

### 5.2.1 ホスティング構成（正式採用）
| 層 | サービス | 役割 |
|----|-----------|------|
| フロントエンド | **Vercel** | PWAホスティング・SSL自動更新 |
| バックエンドAPI | **Supabase Edge Functions / NestJS** | 認証・DBアクセス・API制御 |
| データベース | **Supabase PostgreSQL (RLS)** | テナント分離・翻訳キャッシュ永続化 |
| 認証 | **Supabase Auth + NextAuth** | Magic Link + JWT |
| ストレージ | **Supabase Storage** | 画像・ファイル管理 |
| 通知 | **SendGrid / Firebase Cloud Messaging (FCM)** | メール通知・プッシュ通知 |
| キャッシュ | **Redis** | 翻訳・セッションキャッシュ |
| CDN | **Cloudflare（任意）** | 静的資産配信 |
| モニタリング | **Sentry + UptimeRobot** | 稼働監視・障害検知 |

---

### 5.2.2 デプロイパイプライン
```
[GitHub push]
   ↓
[Vercel Build & Deploy]
   ↓
[Supabase Migration Step (Prisma CI)]
   ↓
[自動HTTPS設定・SSL証明書更新]
```

- GitHub連携により、`main` ブランチへのマージで自動デプロイ。  
- Vercelダッシュボードでのロールバックが可能。  
- SupabaseマイグレーションはGitHub Actions経由で自動実行。  
- Secrets管理はVercelおよびSupabaseの環境変数機構を利用。

---

### 5.2.3 環境構成
| 環境 | 用途 | ドメイン | 備考 |
|------|------|----------|------|
| 開発環境 | ローカルDocker環境 | localhost:3000 | テナント別テストDB |
| ステージング | 検証用 | staging.harmonet.app | Supabase Staging |
| 本番環境 | 住民利用 | app.harmonet.jp | Supabase Production |
| 管理環境 | 運営チーム用 | admin.harmonet.jp | 管理者向けツール群 |

---

## 5.3 バックアップ・監視

### 5.3.1 バックアップ設計
| 対象 | 頻度 | 保管期間 | 保管場所 |
|------|------|----------|-----------|
| データベース | 1日1回 | 7日間 | Supabase自動バックアップ |
| ストレージ（画像） | 随時 | 30日間 | Supabase Versioning |
| コードリポジトリ | コミットごと | 永続 | GitHub |
| 翻訳キャッシュ | 毎週初回再生成 | - | Redis再構築 |
| テナント設定 | 1日1回 | 7日間 | Supabase JSONバックアップ |

リストアはSupabaseコンソールまたはCLIから実行可能。

---

### 5.3.2 監視設計
| 監視対象 | ツール | アラート条件 |
|-----------|--------|---------------|
| サーバ稼働 | UptimeRobot | 応答なし3分継続 |
| エラー検知 | Sentry | 例外発生時Slack通知 |
| DB接続数 | Supabase Monitor | 80%以上で警告 |
| Translation API | Google Cloud Console | 月50万文字の80%超で警告 |
| Redisクラスタ | Supabase Metrics | レイテンシ>100ms時警告 |

---

## 5.4 稼働率・保守体制

| 項目 | 内容 |
|------|------|
| 稼働率目標 | 99%以上（Vercel SLA基準） |
| メンテナンス | 月1回（深夜2:00〜4:00） |
| リリース管理 | Semantic Versioning（例：v1.3.0） |
| バージョン整合 | HarmoNet Technical Stack v3.2を基準とし、他文書と同期更新 |
| 保守担当 | TKD + GPT（AIドキュメント整合・コード生成） |
| 監査ログ管理 | Supabase Audit Logをテナント単位で保持 |

---

# 第6章 制約条件・将来展望（v1.3）

---

## 6.1 開発スコープ制限（MVP）

初期開発フェーズ（MVP）では、以下の制約を設ける。  
これにより開発リソースを集中させ、早期リリースと安定稼働を優先する。

| 区分 | 制約内容 | 備考 |
|------|-----------|------|
| 決済機能 | アプリ内決済なし | 管理費と合算して後日請求 |
| 対応言語 | 日本語・英語・中国語（簡体字） | 繁体字はPhase 2以降 |
| 予約単位 | 1日単位のみ | 時間単位は将来拡張 |
| 対応施設 | 駐車場のみ | 集会所・ゲストルームは将来追加 |
| 同時接続数 | 約100ユーザー | Supabase Freeプラン運用 |
| 通知方式 | メール通知（SendGrid） | プッシュ通知はPhase 2で導入 |
| テナント構成 | **マルチテナント（tenant_idによる論理分離）** | 初期リリースより有効 |

---

## 6.2 将来拡張（フェーズ別計画）

HarmoNetはフェーズ方式で段階的に機能を拡張する。  
各フェーズの新機能は既存構成（Vercel + Supabase + React + NestJS）上にモジュールとして追加される。

---

### フェーズ2（MVP完了後6ヶ月以内）
**キーワード：利便性・通知強化・居住支援**

| カテゴリ | 追加機能 | 概要 |
|-----------|------------|------|
| 消耗品管理（Consumables） | 住民が住宅部品（フィルター・電池等）を確認・注文可能 | テーブル構成：`consumables_items` / `consumables_orders` |
| アンケート機能 | 管理組合が住民向けに質問・集計 | 単一選択・複数選択・自由記述対応 |
| 掃除当番管理 | 当番表の自動生成と通知 | RLSによる班単位管理 |
| プッシュ通知（FCM） | 各種イベントの即時通知 | Firebase Cloud Messaging採用 |
| 翻訳キャッシュ最適化 | Redis + Supabaseに差分保存 | 再翻訳防止・翻訳コスト削減 |

---

### フェーズ3（MVP完了後1年以内）
**キーワード：AI最適化・マルチテナント管理強化・スマート化**

| カテゴリ | 追加機能 | 概要 |
|-----------|-----------|------|
| AI要約 | お知らせ・掲示板投稿の要約生成 | GPTベースの自然言語要約 |
| HEMS連携 | エネルギー使用量の可視化 | 外部API連携（電力会社・HEMSデバイス） |
| マルチテナント管理UI | 複数物件を管理するUI・統計画面 | Supabase RLS + 管理画面強化 |
| AIチャットボット | よくある質問の自動応答 | OpenAI API連携予定 |
| 翻訳品質向上 | DeepL／GPT翻訳併用 | 高精度翻訳選択機構 |
| Cross-Tenant Console | 管理者が複数テナントを一括管理 | System Admin向け機能 |

---

### フェーズ4（MVP完了後2年以内）
**キーワード：IoT・自動化・持続可能性**

| カテゴリ | 追加機能 | 概要 |
|-----------|-----------|------|
| IoTデバイス連携 | スマートロック・温湿度センサー統合 | Supabase Edge経由制御 |
| 異常検知 | 長期間ログインなし／異常アクセス検知 | AIによるパターン分析 |
| コミュニティ活性 | イベント募集・物品シェア・スキル共有 | モジュール化UI拡張 |
| データ分析 | 利用統計・予測分析 | Supabase + Metabase連携 |
| サステナビリティ指標 | 電力・参加率可視化 | 環境負荷分析レポート化 |

---

## 6.3 技術的課題と検討事項

| 項目 | 内容 | 対応方針 |
|------|------|-----------|
| 翻訳コスト管理 | Google Translation APIの無料枠50万文字／月 | Redisキャッシュ＋使用量モニタリング |
| Supabase制限 | 無料プランで接続数上限あり | Proプラン移行時にRLS最適化 |
| 通知分散 | SendGridとFCMの二重管理 | 統一通知マネージャー導入予定 |
| データ保護 | EU圏データ利用時のGDPR対応 | Supabaseリージョン選択で対応 |
| AI生成リソース | 翻訳・要約などAI処理の最適化 | キャッシュ＋非同期処理化でコスト削減 |

---

## 6.4 開発ロードマップ概要

| フェーズ | 期間 | 主な成果物 |
|-----------|------|-------------|
| Phase 1 | 〜2026年5月 | MVP（お知らせ・掲示板・予約・マイページ・**マルチテナント基盤**） |
| Phase 2 | 2026年11月 | 消耗品管理・アンケート・プッシュ通知 |
| Phase 3 | 2027年5月 | AI要約・HEMS連携・マルチテナント管理UI・Cross-Tenant Console |
| Phase 4 | 2028年以降 | IoT連携・予測分析・サステナビリティ指標 |

---

# 第7章 付録・参照資料・リスク管理（v1.3）

---

## 7.1 用語集

| 用語 | 説明 |
|------|------|
| **HarmoNet** | 地域コミュニティ支援アプリ。住民・管理者・管理会社の三者連携を目的とした情報共有基盤。 |
| **MVP（Minimum Viable Product）** | 最小限の機能で市場適合性を検証する開発手法。 |
| **Supabase** | オープンソースのBaaS（Backend as a Service）。PostgreSQL、Auth、Storageを統合提供。 |
| **RLS（Row Level Security）** | PostgreSQLの機能。テナントID単位で行レベルアクセス制御を行う仕組み。 |
| **Magic Link** | メールで送信されたワンクリック認証リンクを利用したパスワードレス認証方式。 |
| **JWT（JSON Web Token）** | 認証情報を署名付きJSON形式で安全に伝達するトークン方式。 |
| **Redis** | 高速インメモリキャッシュ。翻訳結果やセッション情報の保持に使用。 |
| **PWA（Progressive Web App）** | Webアプリをネイティブアプリのように動作させる仕組み。 |
| **i18next** | 多言語対応ライブラリ。UI翻訳を動的に切り替える。 |
| **Edge Functions** | Supabaseのサーバレス実行環境。低遅延でAPI処理を実行。 |
| **FCM（Firebase Cloud Messaging）** | Googleのプッシュ通知サービス。 |
| **SendGrid** | クラウドメール配信サービス。HarmoNetの通知メールで使用。 |
| **HEMS** | Home Energy Management System。家庭エネルギー管理システム。 |

---

## 7.2 関連ドキュメント

| ドキュメント名 | 概要 | 保管場所 |
|----------------|------|-----------|
| **HarmoNet Technical Stack Definition v3.2** | 技術基盤・アーキテクチャ仕様書 | `/docs/00_architecture/` |
| **HarmoNet UI Design Guidelines v1.1** | 画面デザインおよびスタイル仕様 | `/docs/01_basic_design/` |
| **HarmoNet Database Schema v1.0** | テーブル定義・ER図 | `/docs/02_db_design/` |
| **HarmoNet API Specification v1.0** | REST APIエンドポイント仕様 | `/docs/03_api_spec/` |
| **HarmoNet Infrastructure Design v1.0** | 運用環境・監視構成 | `/docs/04_infra/` |
| **Functional Requirements v1.3（全章）** | 機能・非機能・環境・将来展望含む | `/docs/05_requirements/` |

---

## 7.3 外部サービス・API一覧（v3.2準拠）

| サービス | 用途 | 利用プラン | 備考 |
|-----------|------|--------------|------|
| **Supabase** | 認証・DB・Storage | Free〜Pro | BaaS基盤。RLS・Auth統合。 |
| **SendGrid** | メール通知 | Free（100通/月） | 認証・お知らせ通知に使用。 |
| **Firebase Cloud Messaging (FCM)** | プッシュ通知 | 無料 | Phase 2より導入。 |
| **Google Cloud Translation API (Basic v2)** | 自動翻訳 | 無料枠50万文字/月 | Redisキャッシュにより最適化。 |
| **Redis Cloud / Local Redis** | 翻訳・セッションキャッシュ | Free〜Standard | Supabaseと連携し非同期処理最適化。 |
| **Cloudflare CDN** | 静的配信高速化 | Free | 任意導入。 |
| **UptimeRobot** | 稼働監視 | Free | 3分間隔監視。 |
| **Sentry** | アプリケーションエラー監視 | Free〜Pro | Vercel連携で導入済み。 |

---

## 7.4 リスク管理

| リスク項目 | 発生確率 | 影響度 | 対策 |
|-------------|-----------|---------|------|
| 翻訳API使用量超過 | 低 | 中 | Redisキャッシュ・月次監視で制御 |
| Supabaseサービス停止 | 低 | 高 | 日次バックアップ・フェイルオーバー設計 |
| セキュリティインシデント | 中 | 高 | RLS強制適用・ログ監査・脆弱性診断 |
| 大量アクセスによる遅延 | 低 | 中 | CDNキャッシュ・Edge Function導入 |
| AI出力の誤翻訳 | 中 | 低 | 手動修正UI・翻訳履歴保持 |
| **AI要約の誤生成** | 中 | 低 | 再生成ボタン・人間レビュー導入 |
| **テナントスケール増加によるDB負荷** | 中 | 中 | Supabase Proプラン移行＋Redis分散キャッシュ |
| 開発スケジュール遅延 | 中 | 中 | フェーズ単位リリース・優先度管理 |
| 住民利用率低下 | 中 | 高 | UX改善・周知キャンペーン実施 |

---

## 7.5 文書承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| プロジェクトオーナー | __________________ | //__ |
| 開発リーダー | __________________ | //__ |

---

## 7.6 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-------------|------|-----------|---------|
| v1.0 | 2025/10/26 | 初版作成 | TKD |
| v1.1 | 2025/10/26 | 掲示板機能（AIモデレーション）追加 | TKD |
| v1.2 | 2025/10/30 | Supabase／RLS対応、Phase 2〜4拡張反映 | GPT署名 |
| **v1.3** | **2025/10/30** | Technical Stack v3.2準拠化およびリスク項目更新 | **GPT署名** |

---

### 7.7 注意事項
本書はHarmoNet開発チームおよび関係者の内部資料であり、  
**無断複製・再配布・外部共有を禁ずる。**  
すべての内容は HarmoNet Technical Stack Definition v3.2 の技術基盤上で運用される。

---

*by GPT (HarmoNet PMO AI)*  
**（End of Chapter 7）**


