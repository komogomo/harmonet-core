# 第3章 機能要件（前半）v1.2  
対象範囲：ホーム画面、掲示板機能、お知らせ機能  

---

## 3.1 ホーム画面

### 3.1.1 概要
ログイン後のポータル画面。  
Supabase Authで認証済みのユーザー情報を基に、所属テナント（管理組合）とユーザー設定を読み込み、  
各機能モジュールへナビゲートする。

### 3.1.2 主要要素
| 項目 | 概要 |
|------|------|
| ヘッダー | アプリ名「HarmoNet」、言語切替ボタン（JA/EN/CN）、通知アイコン（未読バッジ） |
| ウェルカムエリア | ログイン中ユーザー名、所属情報（例：A棟105号室） |
| 最新お知らせ | 最新3件表示、未読/既読状態をバッジ表示 |
| 機能タイル | 主要機能ショートカット（3×3グリッド） |
| フッター | グローバルナビゲーション（🏠ホーム、🔔お知らせ、💬掲示板、📅予約、👤マイページ） |

### 3.1.3 機能タイル一覧（MVP）
| 名称 | アイコン | 遷移先 | 備考 |
|------|----------|--------|------|
| 駐車場予約 | 📅 | 施設予約TOP | MVP対象 |
| 回覧板 | 📋 | 回覧板一覧 | MVP対象 |
| 掲示板 | 💬 | 掲示板一覧 | MVP対象 |
| 通知設定 | 🔔 | 設定画面 | MVP対象 |
| 見守り | ❤️ | 安否確認 | Phase 2予定 |
| 消耗品 | 🛒 | 消耗品注文（Consumables） | Phase 2予定 |

---

## 3.2 掲示板機能（BBS）

### 3.2.1 概要
住民同士の交流および管理者からの情報発信を担う主要機能。  
投稿内容はSupabase上でテナントIDにより分離され、RLSによって他テナントからは不可視。  
投稿・返信・削除・翻訳・通報などの機能を持つ。

### 3.2.2 掲示板の種類
| 区分 | 概要 | 権限 |
|------|------|------|
| 全体掲示板 | 全住民が閲覧・投稿可能 | 全ユーザー |
| グループ掲示板 | 班・棟単位の掲示板 | 所属ユーザーのみ |
| 回覧板／重要告知 | 管理者専用の一方向掲示 | 管理者のみ投稿可 |

---

### 3.2.3 投稿機能
- 新規スレッド：タイトル・本文・カテゴリ・画像添付に対応  
- 投稿者：実名または匿名（内部的にuser_id保持）  
- Supabase Storageに画像を保存（RLS制御付与）  

```sql
CREATE POLICY tenant_storage_policy
ON storage.objects
USING (bucket_id = auth.jwt() ->> 'tenant_id');
```

---

### 3.2.4 返信・コメント機能
- 返信階層は1段階まで（ネスト不可）  
- 返信時に通知（メールまたはFCM）を自動送信  
- Supabase Triggerでコメント投稿時に通知イベントを発火  

---

### 3.2.5 AIモデレーション
投稿確定前に、AI（GPTモデル）が本文を解析。  
以下の処理を行う。

| 項目 | 内容 |
|------|------|
| 不適切表現検知 | 攻撃的・差別的・個人情報の自動検出 |
| 修正支援 | 軽度な違反は自動書き換え提案（例：「苦情」→「要望」） |
| 投稿拒否 | 原則行わない（検閲ではなく緩和方式） |
| 管理負担軽減 | 理事・管理会社の介入を最小化 |

---

### 3.2.6 閲覧・翻訳
- 一覧表示：カテゴリ／タグ／コメント件数／翻訳ボタン  
- 詳細表示：本文・画像・コメント時系列表示  
- 翻訳ボタン押下でGoogle Cloud Translation APIを呼び出し、結果をRedisキャッシュ  
- 翻訳結果は多言語キャッシュテーブルに保存し、再翻訳を抑制  

---

### 3.2.7 編集・削除・通報
| 区分 | 操作者 | 機能 |
|------|----------|------|
| 投稿者本人 | 自分の投稿を削除可能（論理削除） |
| 管理者 | 全投稿削除可。削除理由をログに記録 |
| 住民 | 通報ボタンで不適切投稿を報告（通報理由を記録） |

---

### 3.2.8 既読・通知
- 投稿・コメントは、閲覧時に自動で既読登録  
- Supabase Functionで `bbs_read_log` テーブルに記録  
- 回覧板タグ付き投稿は「未読件数」を通知に反映  

---

## 3.3 お知らせ機能（Announcements）

### 3.3.1 概要
管理組合や理事会が住民へ情報を一方向に伝達するための機能。  
Phase 1ではメール通知（SendGrid）を実装、Phase 2でプッシュ通知（FCM）を拡張。

---

### 3.3.2 お知らせ一覧
| 項目 | 概要 |
|------|------|
| カテゴリバッジ | 「重要」「イベント」「メンテナンス」「回覧」など |
| タイトル／本文 | 3言語対応（JA/EN/CN） |
| 検索・絞り込み | カテゴリ／未読・既読／日付範囲／キーワード検索 |

---

### 3.3.3 お知らせ詳細
- タイトル・本文・添付画像（最大5枚）を表示  
- 公開期間・既読状態を表示  
- 「確認済み」ボタンで既読登録  
- 翻訳はAPIまたはキャッシュ利用（掲示板と共通処理）

---

### 3.3.4 管理者による作成
- 入力：タイトル、本文（5000文字以内）、カテゴリ、公開日時、画像添付  
- 翻訳ボタンで自動翻訳（日→英・中）  
- プレビューで住民表示確認  
- 公開後、自動でメール通知（Phase 1）  

---

### 3.3.5 通知処理（Phase対応）
| フェーズ | 通知方式 | 実装概要 |
|-----------|------------|-----------|
| Phase 1 | SendGridメール | Supabase FunctionsからAPI呼出 |
| Phase 2 | Firebase Cloud Messaging | 端末トークン登録 + 多言語本文通知 |

---

### 3.3.6 既読・確認管理
- 管理者画面で既読率／未読者リストを閲覧  
- CSV出力対応  
- Supabase Triggerで既読登録時に自動集計  

---

*by GPT (HarmoNet PMO AI)*
