# 共通通知機能設計書 v1.0

**Document ID:** SEC-APP-COMMON-NOTIFICATION-001  
**Version:** 1.0  
**Created:** 2025年10月27日  
**Purpose:** 全画面共通の通知機能詳細仕様

---

## 1. 概要

本ドキュメントは、セキュレアシティ スマートコミュニケーションアプリの**通知機能**の詳細仕様を定義します。

### 1.1 通知機能の役割

- **情報の即時性:** 新しいお知らせや更新を即座にユーザーに伝える
- **優先度の可視化:** 重要な通知を強調表示
- **アクセス性:** ヘッダーの通知ボタンから常にアクセス可能

### 1.2 設計原則

- **非侵入性:** 通知は控えめに表示し、操作を邪魔しない
- **明確性:** 未読件数を明確に表示
- **即応性:** 通知タップ後、即座に詳細へ遷移

---

## 2. 通知ボタン（ヘッダー）

### 2.1 基本仕様

| 項目 | 値 |
|------|-----|
| **位置** | ヘッダー右側（言語切替ボタンの左隣） |
| **サイズ** | 40px × 40px |
| **アイコン** | 🔔（ベル） |
| **タップ領域** | 44px × 44px（最小） |

### 2.2 未読バッジ

未読通知がある場合、ベルアイコンの右上に赤いバッジを表示します。

| 項目 | 値 |
|------|-----|
| **形状** | 円形 |
| **サイズ** | 直径16px |
| **背景色** | 赤色（#f44336） |
| **テキスト色** | 白色（#ffffff） |
| **フォントサイズ** | 10px（太字） |
| **表示内容** | 未読件数（最大99、それ以上は「99+」） |
| **位置** | ベルアイコンの右上（50%重なり） |

### 2.3 表示例

```
未読なし:     🔔
未読1件:      🔔 ①
未読15件:     🔔 ⑮
未読100件以上: 🔔 99+
```

---

## 3. 通知の種類

### 3.1 通知カテゴリ

| カテゴリ | 説明 | アイコン | 優先度 |
|---------|------|---------|--------|
| **お知らせ** | 管理組合からの連絡 | 📢 | 高 |
| **回覧板** | 回覧板の新着・期限 | 📋 | 高 |
| **掲示板** | 掲示板への返信・いいね | 💬 | 中 |
| **駐車場** | 予約確認・キャンセル | 🚗 | 中 |
| **システム** | メンテナンス・障害 | ⚙️ | 低 |

### 3.2 優先度による表示

| 優先度 | バッジ色 | 通知音 | プッシュ通知 |
|--------|---------|--------|------------|
| **高** | 赤色（#f44336） | あり | あり |
| **中** | オレンジ（#ff9800） | なし | あり |
| **低** | グレー（#9e9e9e） | なし | なし |

---

## 4. 通知一覧画面

### 4.1 遷移

ヘッダーの通知ボタンをタップすると、通知一覧画面へ遷移します。

**画面構成:**

```
┌──────────────────────────────────┐
│  ヘッダー: 通知                   │
├──────────────────────────────────┤
│  [すべて既読にする]               │
├──────────────────────────────────┤
│  📢 新しい回覧板が届いています     │
│     秋祭りのお知らせ - 10/20      │
│     [未読]                       │
├──────────────────────────────────┤
│  💬 掲示板に返信がありました       │
│     駐車場ルールについて - 10/19  │
├──────────────────────────────────┤
│  🚗 駐車場予約が確定しました       │
│     11/1 8:00-10:00 - 10/18     │
└──────────────────────────────────┘
```

### 4.2 通知カードの要素

各通知カードには、以下の情報を表示します:

| 要素 | 説明 |
|------|------|
| **カテゴリアイコン** | 通知の種類を示すアイコン |
| **タイトル** | 通知の件名（最大50文字） |
| **サブタイトル** | 詳細情報（投稿者名、日時など） |
| **未読バッジ** | 未読の場合のみ表示 |
| **日時** | 通知が発生した日時 |

### 4.3 インタラクション

| 操作 | 動作 |
|------|------|
| 通知カードをタップ | 該当する詳細画面へ遷移、通知を既読にする |
| 「すべて既読にする」ボタン | すべての通知を既読にする |
| 左スワイプ（モバイル） | 削除ボタンを表示 |
| 削除ボタンをタップ | 通知を削除（確認ダイアログあり） |

---

## 5. 通知の配信

### 5.1 配信タイミング

| イベント | 通知タイミング | 通知先 |
|---------|---------------|--------|
| お知らせ公開 | 即時 | 全住民 |
| 回覧板到着 | 即時 | 該当住民のみ |
| 掲示板返信 | 即時 | 投稿者のみ |
| 駐車場予約確定 | 即時 | 予約者のみ |
| システムメンテナンス | 24時間前 | 全住民 |

### 5.2 配信チャネル

| チャネル | 説明 | 対象 |
|---------|------|------|
| **アプリ内通知** | ヘッダーのバッジ表示 | 全ユーザー |
| **プッシュ通知** | スマートフォンの通知 | 許可したユーザーのみ |
| **メール通知** | 登録メールアドレス宛 | 設定で有効化したユーザーのみ |

### 5.3 プッシュ通知の内容

**基本フォーマット:**

```
タイトル: [カテゴリ名] 通知タイトル
本文: 詳細情報（最大100文字）
アクション: 「開く」「後で」
```

**例:**

```
タイトル: 📢 新しい回覧板が届いています
本文: 秋祭りのお知らせ - 11月3日開催予定
アクション: 「開く」「後で」
```

---

## 6. 未読件数の取得

### 6.1 API エンドポイント

```
GET /api/notifications/unread-count
```

**レスポンス:**

```json
{
  "unread_count": 3
}
```

### 6.2 更新頻度

| タイミング | 説明 |
|-----------|------|
| **ページロード時** | 画面表示時に即座に取得 |
| **5分ごと** | 定期的にポーリング（setInterval） |
| **画面遷移時** | フッターナビゲーションのタップ時 |
| **通知受信時** | プッシュ通知受信時（WebSocket経由） |

### 6.3 タイムアウト

| 項目 | 値 |
|------|-----|
| **API タイムアウト** | 3秒 |
| **エラー時の表示** | バッジを非表示（エラーログは出力） |
| **リトライ** | 3回まで（1秒間隔） |

---

## 7. 通知設定

### 7.1 設定画面

ユーザーは、マイページから通知設定を変更できます。

**設定項目:**

| 項目 | 説明 | デフォルト |
|------|------|-----------|
| **プッシュ通知** | スマートフォンへのプッシュ通知 | ON |
| **メール通知** | 登録メールアドレス宛の通知 | OFF |
| **お知らせ通知** | 管理組合からのお知らせ | ON |
| **回覧板通知** | 回覧板の新着・期限 | ON |
| **掲示板通知** | 掲示板への返信・いいね | ON |
| **駐車場通知** | 予約確認・キャンセル | ON |
| **システム通知** | メンテナンス・障害 | ON |

### 7.2 通知の無効化

すべてのカテゴリを無効化した場合でも、以下の通知は受信されます:
- **緊急メンテナンス**
- **セキュリティアラート**
- **規約変更**

---

## 8. 既読管理

### 8.1 既読の定義

以下の操作で、通知が既読になります:

1. 通知一覧画面で通知をタップ
2. 「すべて既読にする」ボタンをタップ
3. 該当する詳細画面を直接表示

### 8.2 既読データの保存

| 項目 | 値 |
|------|-----|
| **テーブル** | `notification_reads` |
| **カラム** | `user_id`, `notification_id`, `read_at` |
| **保存タイミング** | 通知をタップした瞬間（即座） |

### 8.3 API エンドポイント

**単一通知を既読にする:**

```
PATCH /api/notifications/{id}/read
```

**すべて既読にする:**

```
PATCH /api/notifications/read-all
```

---

## 9. 通知の削除

### 9.1 削除方法

ユーザーは、通知一覧画面から不要な通知を削除できます。

**操作:**

1. 通知カードを左スワイプ（モバイル）
2. 削除ボタンが表示される
3. 削除ボタンをタップ
4. 確認ダイアログ表示: 「この通知を削除しますか？」
5. 「削除」をタップで削除実行

### 9.2 削除の制限

以下の通知は削除できません:
- **重要なお知らせ**（管理組合指定）
- **未読の回覧板**
- **未確認の駐車場予約**

### 9.3 API エンドポイント

```
DELETE /api/notifications/{id}
```

---

## 10. パフォーマンス

### 10.1 目標値

| 項目 | 目標値 |
|------|--------|
| 未読件数の取得 | 1秒以内 |
| 通知一覧の表示 | 2秒以内 |
| 既読処理の応答 | 500ms以内 |

### 10.2 最適化

- **未読件数のキャッシュ:** 5分間有効
- **通知一覧のページネーション:** 1ページ20件
- **画像の遅延読み込み:** スクロール時に読み込み

---

## 11. アクセシビリティ

### 11.1 スクリーンリーダー対応

```html
<button aria-label="通知 (未読3件)" class="notification-btn">
  <span class="notification-icon" aria-hidden="true">🔔</span>
  <span class="notification-badge" aria-hidden="true">3</span>
</button>
```

### 11.2 キーボード操作

| 操作 | 動作 |
|------|------|
| Tab キー | 通知ボタンにフォーカス |
| Enter / Space キー | 通知一覧画面へ遷移 |

---

## 12. セキュリティ

### 12.1 アクセス制御

- 通知は、該当ユーザーのみが閲覧可能
- API 呼び出し時にセッショントークンを検証

### 12.2 データの保持期間

| 通知タイプ | 保持期間 |
|-----------|---------|
| **お知らせ** | 1年間 |
| **回覧板** | 6ヶ月 |
| **掲示板** | 3ヶ月 |
| **駐車場** | 3ヶ月 |
| **システム** | 1ヶ月 |

保持期間を過ぎた通知は、自動的に削除されます。

---

## 13. 実装例

### 13.1 HTML

```html
<!-- ヘッダーの通知ボタン -->
<button class="notification-btn" aria-label="通知 (未読3件)">
  <span class="notification-icon">🔔</span>
  <span class="notification-badge">3</span>
</button>
```

### 13.2 JavaScript（未読件数の取得）

```javascript
// 未読件数を取得
async function fetchUnreadCount() {
  try {
    const response = await fetch('/api/notifications/unread-count', {
      headers: {
        'Authorization': `Bearer ${sessionToken}`
      }
    });
    const data = await response.json();
    updateBadge(data.unread_count);
  } catch (error) {
    console.error('Failed to fetch unread count:', error);
  }
}

// バッジを更新
function updateBadge(count) {
  const badge = document.querySelector('.notification-badge');
  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// 5分ごとに更新
setInterval(fetchUnreadCount, 5 * 60 * 1000);
```

---

## 14. 関連ドキュメント

| ドキュメント名 | 説明 |
|--------------|------|
| `common-header-v1_0.md` | ヘッダー領域（通知ボタン） |
| `common-design-system-v1_0.md` | デザインシステム（バッジ色） |
| `common-security-v1_0.md` | セキュリティ要件 |

---

**文書管理**
- 文書ID: SEC-APP-COMMON-NOTIFICATION-001
- バージョン: 1.0
- 作成日: 2025年10月27日
- 承認者: （未定）
