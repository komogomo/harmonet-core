# 第2章: 認証フローと画面構成

**Document:** LOGIN画面 機能設計書 v1.0  
**Chapter:** 2 of 6  
**Last Updated:** 2025/10/27

---

## 2.1 認証フロー全体図

マジックリンク認証の全体的な流れを示します。

### フロー図

```
┌─────────────────────────────────────────────────────────────┐
│                     認証フロー全体図                          │
└─────────────────────────────────────────────────────────────┘

[ユーザー]              [ブラウザ]           [サーバー]         [メールサーバー]

    │                      │                     │                    │
    │ ① メールアドレス      │                     │                    │
    │   テナントID入力      │                     │                    │
    ├──────────────────────>│                     │                    │
    │                      │                     │                    │
    │                      │ ② ログイン要求      │                    │
    │                      │ (POST /api/login)   │                    │
    │                      ├────────────────────>│                    │
    │                      │                     │                    │
    │                      │                     │ ③ テナント検証      │
    │                      │                     │   メールアドレス検証 │
    │                      │                     │   トークン生成      │
    │                      │                     │                    │
    │                      │                     │ ④ メール送信要求    │
    │                      │                     ├───────────────────>│
    │                      │                     │                    │
    │                      │ ⑤ 送信完了応答      │                    │
    │                      │<────────────────────│                    │
    │                      │                     │                    │
    │ ⑥ メール送信完了画面  │                     │                    │
    │<─────────────────────│                     │                    │
    │                      │                     │                    │
    │                                             │ ⑦ マジックリンク送信 │
    │<──────────────────────────────────────────────────────────────│
    │                      │                     │                    │
    │ ⑧ メール受信・確認    │                     │                    │
    │                      │                     │                    │
    │ ⑨ マジックリンク     │                     │                    │
    │   クリック            │                     │                    │
    ├──────────────────────>│                     │                    │
    │                      │                     │                    │
    │                      │ ⑩ トークン検証      │                    │
    │                      │ (GET /api/verify)   │                    │
    │                      ├────────────────────>│                    │
    │                      │                     │                    │
    │                      │                     │ ⑪ トークン検証      │
    │                      │                     │   セッション生成    │
    │                      │                     │   トークン無効化    │
    │                      │                     │                    │
    │                      │ ⑫ 認証成功・         │                    │
    │                      │   セッションCookie   │                    │
    │                      │<────────────────────│                    │
    │                      │                     │                    │
    │ ⑬ HOME画面表示       │                     │                    │
    │<─────────────────────│                     │                    │
    │                      │                     │                    │
```

### フローの各ステップ

| ステップ | 説明 | 処理時間目安 |
|---------|------|-------------|
| ① | ユーザーがメールアドレスとテナントIDを入力 | - |
| ② | ブラウザからサーバーへログイン要求を送信 | - |
| ③ | サーバーでテナントID・メールアドレスを検証し、ワンタイムトークンを生成 | 200ms以内 |
| ④ | メールサーバーへメール送信要求 | - |
| ⑤ | サーバーからブラウザへ送信完了応答 | 500ms以内 |
| ⑥ | ブラウザにメール送信完了画面を表示 | - |
| ⑦ | メールサーバーからユーザーのメールボックスへマジックリンクを送信 | 10秒〜5分 |
| ⑧ | ユーザーがメールを受信・確認 | - |
| ⑨ | ユーザーがマジックリンクをクリック | - |
| ⑩ | ブラウザからサーバーへトークン検証要求 | - |
| ⑪ | サーバーでトークン検証、セッション生成、トークン無効化 | 200ms以内 |
| ⑫ | サーバーからブラウザへ認証成功応答とセッションCookie | - |
| ⑬ | ブラウザにHOME画面を表示 | - |

---

## 2.2 画面遷移図

### 画面遷移フロー

```
┌──────────────────┐
│                  │
│  ログイン画面     │
│                  │
│  [送信]ボタン     │
│                  │
└────────┬─────────┘
         │
         │ ログイン要求
         │
         ▼
┌──────────────────┐
│                  │
│ メール送信完了    │
│    画面          │
│                  │
│  [再送信]ボタン   │
│                  │
└────────┬─────────┘
         │
         │ ユーザーがメールを確認
         │ マジックリンクをクリック
         │
         ▼
┌──────────────────┐
│                  │
│   HOME画面       │
│                  │
│  (ログイン完了)   │
│                  │
└──────────────────┘
```

### エラー時の遷移

```
ログイン画面
    │
    ├─ [バリデーションエラー] → 同一画面でエラー表示
    │
    ├─ [テナントID不一致] → 同一画面でエラー表示
    │
    ├─ [メールアドレス未登録] → 同一画面でエラー表示
    │
    └─ [ネットワークエラー] → 同一画面でエラー表示

メール送信完了画面
    │
    ├─ [再送信失敗] → 同一画面でエラー表示
    │
    └─ [レート制限超過] → 同一画面でエラー表示

マジックリンククリック
    │
    ├─ [トークン無効] → エラー画面表示
    │
    ├─ [トークン期限切れ] → エラー画面表示
    │
    └─ [トークン使用済み] → エラー画面表示
```

---

## 2.3 マジックリンクの仕組み

### トークン生成

**生成方式:**
- 暗号学的に安全な乱数生成器（CSPRNG）を使用
- トークン長：32〜64文字（推奨：48文字）
- エンコーディング：Base64 URL-safe

**生成例:**
```
トークン: Xa7k9Pm2Qr5tLw8NvZ3eB1cF6hG4jM0sD8kR7pY2tW5nA9qU
```

**データベース保存:**
- トークンはハッシュ化（SHA-256）して保存
- 生のトークンは保存しない（漏洩時のリスク軽減）

### マジックリンクURL

**URL形式:**
```
https://[domain]/auth/verify?token=[TOKEN]&tenant=[TENANT_ID]
```

**例:**
```
https://app.securea-city.jp/auth/verify?token=Xa7k9Pm2Qr5tLw8NvZ3eB1cF6hG4jM0sD8kR7pY2tW5nA9qU&tenant=TKSC01
```

**パラメータ:**
| パラメータ | 説明 | 必須 |
|----------|------|------|
| token | ワンタイムトークン | ✅ |
| tenant | テナントID | ✅ |

### トークンの有効期限

**推奨設定:**
- 有効期限：15分〜30分
- 本アプリ：**30分**

**有効期限の理由:**
- 短すぎる：メール遅延で使えない可能性
- 長すぎる：セキュリティリスク増加
- 30分：バランスの取れた設定

### ワンタイム使用の保証

**仕組み:**
```
1. トークンがクリックされたらDB内のステータスを「使用済み」に更新
2. 同じトークンで再度アクセスがあった場合、「既に使用済み」エラーを返す
3. ログイン成功時にトークンを削除または無効化
```

**データベース設計:**
```sql
CREATE TABLE magic_link_tokens (
  id UUID PRIMARY KEY,
  token_hash VARCHAR(64) NOT NULL,
  tenant_id VARCHAR(6) NOT NULL,
  email VARCHAR(255) NOT NULL,
  status ENUM('active', 'used', 'expired') DEFAULT 'active',
  created_at TIMESTAMP NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP,
  INDEX idx_token_hash (token_hash),
  INDEX idx_expires_at (expires_at)
);
```

---

## 2.4 テナント識別の仕組み

### テナントIDの役割

**1. データベース分離**
- テナントIDに基づいて適切なスキーマ・テーブルにアクセス
- テナント間のデータ漏洩を防止

**2. 設定の分離**
- テナントごとの設定値を管理
- カスタマイズ可能な項目を分離

**3. 認証の制限**
- ユーザーは自身が所属するテナントのみにログイン可能
- クロステナントアクセスを防止

### 検証プロセス

**ログイン時の検証:**
```
1. 入力されたテナントIDの形式チェック（AABB99）
2. テナントマスタテーブルで存在確認
3. テナントのステータス確認（有効/無効）
4. メールアドレスが該当テナントに所属しているか確認
```

**検証SQL例:**
```sql
SELECT 
  t.tenant_id,
  t.status,
  u.user_id,
  u.email
FROM tenants t
INNER JOIN users u ON t.tenant_id = u.tenant_id
WHERE t.tenant_id = ? 
  AND u.email = ?
  AND t.status = 'active';
```

### テナントマスタ構造

```sql
CREATE TABLE tenants (
  tenant_id VARCHAR(6) PRIMARY KEY,
  tenant_name VARCHAR(255) NOT NULL,
  area_code CHAR(2) NOT NULL,
  brand_code CHAR(2) NOT NULL,
  region_code CHAR(2) NOT NULL,
  status ENUM('active', 'suspended', 'deleted') DEFAULT 'active',
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);
```

---

## 2.5 セキュリティ考慮事項の概要

### 主要なセキュリティ対策

**1. トークンのセキュリティ**
- CSPRNG使用による予測不可能なトークン生成
- トークンのハッシュ化保存
- ワンタイム使用の強制
- 有効期限の設定（30分）

**2. レート制限**
- ログイン試行回数制限（IP単位、メールアドレス単位）
- メール送信回数制限（同一メールアドレス、システム全体）
- ロックアウト機能（一定回数超過時）

**3. 通信のセキュリティ**
- HTTPS通信の必須化（TLS 1.2以上）
- セキュアなCookie設定（HttpOnly, Secure, SameSite）
- HSTS（HTTP Strict Transport Security）

**4. 入力のセキュリティ**
- SQLインジェクション対策（プリペアドステートメント）
- XSS対策（入力値のサニタイゼーション）
- CSRF対策（CSRFトークン）

**5. ログとモニタリング**
- ログイン試行の記録（成功/失敗）
- 異常なアクセスパターンの検知
- セキュリティインシデントのアラート

**詳細は第5章で説明します。**

---

## 2.6 画面構成の共通要素

### 3層構造

本アプリの全画面（ログイン画面、メール送信完了画面を含む）は、統一された3層構造を採用します。

```
┌─────────────────────────────────┐
│   【ヘッダー領域】Layer 1        │  ← 共通（言語切替のみ）
├─────────────────────────────────┤
│                                 │
│   【コンテンツ領域】Layer 2      │  ← 画面固有
│                                 │
├─────────────────────────────────┤
│   【フッター領域】Layer 3        │  ← 共通（アイコンなし）
└─────────────────────────────────┘
```

### ログイン画面における3層構造

**Layer 1: ヘッダー領域**
- アプリタイトル表示
- 言語切替ボタン（日本語、英語、中国語）
- **注：** ログイン前なので、ユーザー情報は非表示

**Layer 2: コンテンツ領域**
- タイトル・サブタイトル
- 入力フォーム（メールアドレス、テナントID）
- 送信ボタン
- エラーメッセージ表示エリア

**Layer 3: フッター領域**
- 利用規約リンク
- プライバシーポリシーリンク
- お問い合わせリンク
- コピーライト表示
- **注：** ナビゲーションアイコンは非表示（ログイン前のため）

### メール送信完了画面における3層構造

**Layer 1: ヘッダー領域**
- アプリタイトル表示
- 言語切替ボタン

**Layer 2: コンテンツ領域**
- 成功アイコン
- 完了メッセージ
- 説明文
- 再送信ボタン

**Layer 3: フッター領域**
- 利用規約リンク
- プライバシーポリシーリンク
- お問い合わせリンク
- コピーライト表示
- **注：** ナビゲーションアイコンは非表示（ログイン前のため）

---

**[← 前の章: 第1章 概要と目的](login-feature-design-ch01.md)**

**[次の章へ: 第3章 ログイン画面詳細 →](login-feature-design-ch03.md)**

**[目次に戻る ↑](login-feature-design-ch00-index.md)**
