# 第3章 機能要件（後半）v1.2  
対象範囲：施設予約、マイページ、共通機能  

---

## 3.4 施設予約（Facility Reservation）

### 3.4.1 概要
共用施設（駐車場・集会所など）の予約をオンラインで行う機能。  
MVPでは「ゲスト用駐車場」を対象とし、将来的に他施設へ拡張可能。  
予約データはSupabase PostgreSQL上でtenant_idにより分離され、排他制御を行う。

---

### 3.4.2 予約ルール（MVP: 駐車場）

| 項目 | 内容 |
|------|------|
| 対象台数 | 12台（表F1〜F6、裏B1〜B6） |
| 利用料金 | 1日100円（後日請求） |
| 予約単位 | 1日単位（時間単位予約なし） |
| 予約期間 | 当日〜30日先まで |
| 最大連続予約 | 3日間まで |
| 決済方法 | アプリ内決済なし（将来追加） |

---

### 3.4.3 予約フロー

1. カレンダー画面で希望日を選択  
2. MAP表示で空き区画を確認（色分け：青=空、灰=予約済、緑=自分）  
3. 駐車場所を選択 → 予約確認ダイアログ表示  
4. 「予約を確定する」押下でSupabase Functionを呼び出し、  
　排他チェック・保存・メール通知を同時実行  

```sql
-- Supabase Function (Simplified)
BEGIN;
  SELECT * FROM parking_reservations
    WHERE date = $1 AND slot = $2 AND tenant_id = current_setting('app.tenant_id')
    FOR UPDATE;
  INSERT INTO parking_reservations (...);
COMMIT;
```

5. 予約確定後に自動メール通知（SendGrid）  
6. Phase 2でFCMプッシュ通知も送信予定  

---

### 3.4.4 通知仕様
| イベント | 通知内容 | 配信方式 |
|-----------|------------|------------|
| 予約確定 | 駐車場番号・日付・料金 | SendGridメール（Phase 1） |
| 予約キャンセル | キャンセル確認通知 | SendGridメール |
| リマインダー | 前日18時に通知 | FCMプッシュ（Phase 2） |

---

### 3.4.5 管理者機能
| 機能 | 内容 |
|------|------|
| 予約状況確認 | 全区画をカレンダー形式で表示 |
| 代理予約 | 管理者が住民に代わって予約可能 |
| 予約ブロック設定 | 特定日を予約不可に設定（メンテナンス時） |
| 統計レポート | 月別稼働率／人気区画CSV出力（将来） |

---

## 3.5 マイページ（My Page）

### 3.5.1 概要
住民が自身の情報・設定・履歴を管理する画面。  
Supabase Authから取得したユーザー情報を基に動的描画される。

---

### 3.5.2 主な機能一覧
| カテゴリ | 機能概要 | 備考 |
|-----------|------------|------|
| プロフィール設定 | 氏名・メール・言語設定の変更 | 言語はJA/EN/CN |
| 通知設定 | メール／プッシュ通知のON/OFF | 機能別設定可能 |
| 掲示板投稿履歴 | 自身の投稿・コメント履歴参照 | 編集／削除可 |
| 予約履歴 | 駐車場予約履歴の閲覧・キャンセル | 未来／過去区別表示 |
| 当番表（将来） | 清掃当番スケジュール表示 | Phase 3予定 |
| 管理者設定 | 管理者のみ表示（ユーザー登録・カテゴリ設定） | tenant_adminロール限定 |

---

### 3.5.3 管理者専用機能
- **ユーザー登録**：Supabase Auth連携。メールアドレス重複チェック。  
- **一括登録**：CSVインポート（氏名, メール, 言語, 権限）  
- **削除**：論理削除フラグで無効化。  
- **権限管理**：`role` クレームで権限判定（member / tenant_admin / system_admin）  

---

## 3.6 共通機能（Global Features）

### 3.6.1 ヘッダー
- 左：アプリロゴ「HarmoNet」  
- 右：通知アイコン + 言語切替ボタン  
- 言語切替はi18nextを利用し、Supabase DB上の翻訳マスタを参照  

```sql
translation_master
- key (varchar)
- ja_text
- en_text
- cn_text
- updated_at
```

---

### 3.6.2 フッター
固定ナビゲーションとして以下のショートカットを配置。  

| アイコン | ラベル | 遷移先 |
|----------|---------|--------|
| 🏠 | ホーム | ホーム画面 |
| 🔔 | お知らせ | お知らせ一覧 |
| 💬 | 掲示板 | 掲示板一覧 |
| 📅 | 予約 | 駐車場予約TOP |
| 👤 | マイページ | マイページ |

アクティブ状態は青ハイライト。  
ログアウトはSupabase Authセッション削除で実装。

---

### 3.6.3 多言語対応
- 静的UI：翻訳マスタ（i18next）で即時切替  
- 動的コンテンツ：Google Translation APIで翻訳＋Redisキャッシュ  
- 翻訳コストは月50万文字以内（無料枠内運用）  
- 翻訳履歴をSupabase内に保存し、再翻訳を防止  

---

### 3.6.4 セッション管理
- Supabase JWTをHTTPOnly Cookieで管理  
- 有効期限15分／自動更新あり  
- 管理者によるセッション失効API提供  

---

### 3.6.5 通知共通基盤
| 要素 | 概要 |
|------|------|
| メール送信 | SendGrid（Phase 1） |
| プッシュ通知 | Firebase Cloud Messaging（Phase 2） |
| 多言語制御 | i18nextで件名・本文を多言語生成 |
| 配信設定 | ユーザー単位でON/OFF制御 |

---

*by GPT (HarmoNet PMO AI)*
