# HarmoNet 機能要件定義書  
## 第3章 Part2 施設予約・マイページ・共通機能  
**Version 1.3 / 2025-10-30**  
**更新履歴**: Geminiレビュー反映およびマルチテナント設計明確化（施設設定、料金、予約期間、デザインガイドライン統一）

本章は **HarmoNet Technical Stack Definition v3.2** に準拠する。  
HarmoNetは Supabase / Prisma / NestJS / React / Tailwind / Redis / Vercel を中核とする  
マルチテナント型SaaS基盤上に構築される。

---

## 3.4 施設予約（Facility Reservation）

### 3.4.1 概要
共用施設（駐車場・集会所など）の予約をオンラインで行う機能。  
本機能は初期リリース時点から**マルチテナント対応設計**とし、施設情報（施設名・施設数・駐車場台数・区画番号ルール・駐車場MAP等）はテナント単位で独立管理される。  
MVPでは「ゲスト用駐車場」を初期対象とし、他施設への適用はテナント設定により柔軟に拡張可能。

---

### 3.4.2 予約ルール（MVP: 駐車場）

| 項目 | 内容 |
|------|------|
| 対象台数 | テナント毎に異なる。例：12台（表F1〜F6、裏B1〜B6）など、管理画面で定義可能。 |
| 利用料金 | テナント毎に設定可能（無料／有料、金額単位を含む）。初期値：1日100円（後日請求）。 |
| 予約単位 | 1日単位（時間単位予約なし）。 |
| 予約期間 | 当日〜翌月末まで（デフォルト）。テナント設定により調整可能。 |
| 最大連続予約 | デフォルト3日間。テナント管理者が管理画面から変更可能。 |
| 決済方法 | アプリ内決済は未実装（Phase 2で導入予定）。テナント単位で有効化可能とする設計。 |

---

### 3.4.3 予約フロー

1. カレンダー画面で希望日を選択  
2. MAP表示で空き区画を確認（色分け：青=空、灰=予約済、緑=自分）  
3. 駐車場所を選択 → 予約確認ダイアログ表示  
4. 「予約を確定する」押下でSupabase Functionを呼び出し、  
　排他チェック・保存・通知送信を同時実行  

```sql
-- Supabase Function (Simplified)
BEGIN;
  SELECT * FROM parking_reservations
    WHERE date = $1 AND slot = $2 AND tenant_id = current_setting('app.tenant_id')
    FOR UPDATE;
  INSERT INTO parking_reservations (...);
COMMIT;
```

5. 予約確定後に自動メール通知（SendGrid）  
6. Phase 2でFCMプッシュ通知も送信予定（マイページ設定で制御）

---

### 3.4.4 通知仕様
| イベント | 通知内容 | 配信方式 |
|-----------|------------|------------|
| 予約確定 | 駐車場番号・日付・料金 | SendGridメール（Phase 1） |
| 予約キャンセル | キャンセル確認通知 | SendGridメール |
| リマインダー | 前日18時に通知 | FCMプッシュ（Phase 2） |

通知ON/OFFはマイページの「通知設定」で一元管理される。

---

### 3.4.5 管理者機能
| 機能 | 内容 |
|------|------|
| 予約状況確認 | 全区画をカレンダー形式で表示 |
| 代理予約 | 管理者が住民に代わって予約可能 |
| 予約ブロック設定 | 特定日を予約不可に設定（メンテナンス時） |
| 統計レポート | 月別稼働率／人気区画CSV出力（将来） |

---

## 3.5 マイページ（My Page）

### 3.5.1 概要
住民が自身の情報・設定・履歴を管理する画面。  
Supabase Authから取得したユーザー情報を基に動的描画される。  
通知設定や言語設定などの共通情報を一元管理する中核機能。

---

### 3.5.2 主な機能一覧
| カテゴリ | 機能概要 | 備考 |
|-----------|------------|------|
| プロフィール設定 | 氏名・メール・言語設定の変更 | 言語はJA/EN/ZH |
| 通知設定 | メール／プッシュ通知のON/OFF | 機能別設定可能（掲示板／お知らせ／予約） |
| 掲示板投稿履歴 | 自身の投稿・コメント履歴参照 | 編集／削除可 |
| 予約履歴 | 駐車場予約履歴の閲覧・キャンセル | 未来／過去区別表示 |
| 当番表（将来） | 清掃当番スケジュール表示 | Phase 3予定 |
| 管理者設定 | 管理者のみ表示（ユーザー登録・カテゴリ設定） | tenant_adminロール限定 |

---

### 3.5.3 管理者専用機能
- **ユーザー登録**：Supabase Auth連携。メールアドレス重複チェック。  
- **一括登録**：CSVインポート（氏名, メール, 言語, 権限）  
- **削除**：論理削除フラグで無効化。  
- **権限管理**：`role` クレームで権限判定（member / tenant_admin / system_admin）  

---

## 3.6 共通機能（Global Features）

### 3.6.1 ヘッダー
- 左：アプリロゴ「HarmoNet」  
- 右：通知アイコン + 言語切替ボタン  
- 言語切替は **静的テキストのみ** 即時反映（i18next利用）  
- 投稿やコメントなどの動的データは、個別翻訳ボタンで処理  
- デザインガイドライン準拠：白基調・角丸2xl・BIZ UDゴシック・最小限シャドウ  

```sql
translation_master
- key (varchar)
- ja_text
- en_text
- zh_text
- updated_at
```

---

### 3.6.2 フッター
固定ナビゲーションとして以下のショートカットを配置。  

| アイコン | ラベル | 遷移先 |
|----------|---------|--------|
| 🏠 | ホーム | ホーム画面 |
| 🔔 | お知らせ | お知らせ一覧 |
| 💬 | 掲示板 | 掲示板一覧 |
| 📅 | 予約 | 駐車場予約TOP |
| 👤 | マイページ | マイページ |

アクティブ状態は青ハイライト。  
ログアウトはSupabase Authセッション削除で実装。

---

### 3.6.3 多言語対応（v1.3統一仕様）
- 静的UI：翻訳マスタ（i18next）で即時切替。  
- 動的コンテンツ：各投稿やお知らせ本文下部に「翻訳」ボタンを配置し、押下時にユーザロケールで翻訳表示。  
- 翻訳結果はRedisキャッシュに保持（キー：`translation:{post_id}:{lang}`）。  
- 翻訳履歴をSupabase内に保存し、再翻訳を防止。  

---

### 3.6.4 セッション管理
- Supabase JWTをHTTPOnly Cookieで管理。  
- 有効期限15分／自動更新あり。  
- 管理者によるセッション失効APIを提供。

---

### 3.6.5 通知共通基盤
| 要素 | 概要 |
|------|------|
| メール送信 | SendGrid（Phase 1） |
| プッシュ通知 | Firebase Cloud Messaging（Phase 2） |
| 多言語制御 | i18nextで件名・本文を多言語生成 |
| 配信設定 | ユーザー単位でON/OFF制御（マイページ設定連携） |

**Phase 2通知対象（FCM）**  
- 掲示板：通報対応結果、重要投稿通知  
- お知らせ：新規配信通知  
- 施設予約：リマインダー・キャンセル通知  

---

### 3.6.6 非機能要件補足
| 区分 | 要件内容 | 指標値 |
|------|-----------|--------|
| レイテンシ | 通知配信API応答 | < 1秒 |
| 翻訳キャッシュヒット率 | Redis | > 85% |
| UI応答速度 | ヘッダー／フッター共通部品 | < 0.5秒 |
| モバイル互換性 | iOS / Android | Safari, Chrome最新安定版 |

---

*by GPT (HarmoNet PMO AI)*  
**（End of Part2）**
