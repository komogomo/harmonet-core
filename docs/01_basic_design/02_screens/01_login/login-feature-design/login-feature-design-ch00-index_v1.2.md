# ログイン画面 機能設計書

| ドキュメントID | SEC-APP-LOGIN-FEATURE-001 |
| --- | --- |
| **バージョン** | **v1.2 (v1.1 -> v1.2)** |
| **作成日** | 2025年10月27日 |
| **更新日** | **2025年10月28日** |
| **作成者** | TKE + タチコマ |
| **承認者** | (未定) |

---

## 1. 概要

### 1.1 目的
本ドキュメントは、HarmoNetアプリケーションの「ログイン画面」および「メール送信完了画面」の機能要件、UI仕様、および関連するフローを定義する。

### 1.2 画面ID
| 画面ID | 画面名 | ファイル名 |
| --- | --- | --- |
| `01-01` | ログイン画面 | `01-login-final_v1.1.html` |
| `01-02` | メール送信完了画面 | `01-login-email-sent-v1.1.html` |

### 1.3 関連ドキュメント
| ドキュメント名 | 説明 |
| --- | --- |
| `common-layout-v1_1.md` | 3層構造の全体設計 |
| `common-header-v1_1.md` | 共通ヘッダー仕様 |
| `common-footer-v1_1.md` | 共通フッター仕様 (本画面は対象外) |
| `common-security-v1_0.md` | 共通セキュリティ要件 |
| **`common-error-handling.md`** | **共通エラーハンドリング仕様 (★v1.2 追記)** |

---

## 2. 画面レイアウト (ワイヤーフレーム)

### 2.1 構造
`common-layout-v1_1.md` に準拠した3層構造（ヘッダー、コンテンツ、フッター）を採用する。

* **Header**: `common-header-v1_1.md` に準拠した共通ヘッダーを表示。
* **Content**: ログインフォームを配置するメイン領域。
* **Footer**: ログイン画面固有の情報フッター（利用規約、コピーライトなど）を表示。

### 2.2 レスポンシブ設計
`common-contents-layout_v1.1.md` に準拠し、モバイルファーストで設計する。
`login-card` は画面中央に配置し、最大幅（`max-width: 420px`）を設ける。

---

## 3. UIコンポーネント仕様

### 3.1 ログインカード (`login-card`)
`common-contents-layout_v1.1.md` のカード定義に準拠し、角丸は `var(--radius-xl)` (1.5rem) を適用する。

### 3.2 フォーム (`.form-input`)
画面固有のスタイルとして定義。フォーカス時に `var(--color-action-blue)` で枠線を強調表示する。

### 3.3 送信ボタン (`.btn-submit`)
画面固有のスタイルとして定義。`var(--color-action-blue)` を基調とするプライマリボタン。

---

## 4. 機能要件

### 4.1 画面機能

#### 4.1.1 ログインフォーム
ユーザーが認証情報を入力するためのフォーム。
* **メールアドレス**: 必須入力。
* **テナントID**: 必須入力。

#### 4.1.2 ログインボタン (ログインリンクを送信)
入力された情報（メールアドレス、テナントID）をサーバーに送信し、認証フローを開始する。

**★【v1.1 追記】★**
#### 4.1.3 レート制限
「ログインリンクを送信」ボタンのレート制限は、**`common-error-handling.md`** の定義（`error.auth.rateLimit` など）に従うこと。
* (v1.1での決定: 1分間に3回まで)

### 4.2 認証フロー

本システムは **マジックリンク認証（パスワードレス）** を採用する。

1.  ユーザーがフォームに「メールアドレス」と「テナントID」を入力し、「ログインリンクを送信」ボタンをクリックする。
2.  サーバーは、テナントIDが有効か、かつメールアドレスがそのテナントIDの住民台帳に登録されているか（`active` ステータスか）を検証する。 (詳細は 6.2 参照)
3.  検証が成功した場合、サーバーは一意のトークン（JWT）を生成し、`https://app.harmon.net/auth/verify?token=[TOKEN]` の形式のマジックリンクを作成する。
4.  サーバーは、登録されたメールアドレス宛にマジックリンクを含むメールを送信する。
5.  同時に、画面を「メール送信完了画面」(`01-02`)に遷移させる。
6.  ユーザーがメール内のマジックリンクをクリックする。
7.  サーバーはリンクのトークンを検証する。(詳細は 6.3 参照)
8.  検証が成功した場合、`common-security-v1_0.md` に基づき、HttpOnly Cookie にセッション情報を格納し、ユーザーを `02_home`（HOME画面）にリダイレクトする。

**★【v1.1 追記】★**
#### 4.2.2 マジックリンク仕様
認証に使用するマジックリンク（トークン）は、以下のライフサイクルを持つ。

| 項目 | 値 | 備考 |
| --- | --- | --- |
| **有効期限** | 発行から15分 | 期限切れのリンクをクリックした場合、エラーハンドリング(6.3)に従う |
| **使用回数** | 1回限り | 一度使用されたトークンは即座に無効化される |

### 4.3 メール送信完了画面 (`01-02`)
ログインリンクが送信されたことをユーザーに通知する静的な画面。
* 「メールを送信しました」というメッセージを表示する。
* （デモ用）HOME画面への遷移をシミュレートする「マジックリンクをクリック(デモ)」ボタン (`.btn-magic-link`) を配置する。
* メールが届かないユーザーのために「再送信する」ボタン (`.btn-resend`) を配置する。

---

## 5. 状態管理
* ログイン状態（認証済みか否か）は、HttpOnly Cookie に格納されたJWTの有無によってグローバルに管理する。

---

**★【v1.2 更新】★**
## 6. バリデーションとエラーハンドリング
(※ 章の名前を「6. バリデーション」から変更)

### 6.1 クライアントサイド バリデーション
クライアントサイドで以下のバリデーションを実行する。

* **メールアドレス**:
    * 必須入力であるか。
    * メールアドレスの**形式**（`a@b.com`）であるか。
* **テナントID**:
    * 必須入力であるか。

### 6.2 サーバーサイド バリデーション
サーバーサイドで以下のバリデーションを実行する。

* **テナントID**:
    * システムに存在する有効なテナントIDであるか。
* **メールアドレス**:
    * 該当テナントIDの住民台帳に登録されているか。
    * アカウントステータスが `active` か。

**★【v1.2 更新】★**
### 6.3 画面固有のエラーハンドリング (UX)
本画面固有のバリデーションエラー発生時のUXを定義する。

| 発生条件 | 表示メッセージ（ユーザーへの通知） | 備考 |
| --- | --- | --- |
| **クライアントサイド バリデーションエラー**<br> (メールアドレスの形式が不正など) | 正しいメールアドレスの形式で入力してください。 | エラー内容に応じてメッセージを出し分ける |
| **サーバーサイド バリデーションエラー**<br> (形式は正しいが、DBに登録がない等) | 入力されたアドレス宛にログインリンクを送信しました。 | DB登録有無を秘匿するため、成功時と同じメッセージを表示（メールは送信しない） |

**★【v1.2 追記】★**
### 6.4 共通エラーハンドリング
上記（6.3）以外の、API通信や認証に関わるシステム共通のエラー（マジックリンク無効、レート制限、セッション切れ、サーバーエラー等）の仕様は、**`common-error-handling.md`** の定義に従うこと。

---

## 7. セキュリティ
(※ 章番号は元の v1.0 と同じ)
詳細は `common-security-v1_0.md` を参照。
* XSS, CSRF対策を講じる。
* HttpOnly, Secure, SameSite=Strict 属性付きのCookieを使用する。
* 通信はすべてHTTPSで行う。

## 8. パフォーマンス
(※ 章番号は元の v1.0 と同じ)
詳細は `common-performance_v1.0.md` を参照。
* LCP 1.0秒以下を目標とする。

## 9. 翻訳 (i18n)
(※ 章番号は元の v1.0 と同じ)
| キー | 日本語 | 英語 |
| --- | --- | --- |
| `login.title` | ログイン | Login |
| `login.email` | メールアドレス | Email Address |
| `login.sendLink` | ログインリンクを送信 | Send Login Link |
| `login.emailSent.title` | メールを送信しました | Email Sent |
| `login.emailSent.body` | ...メールボックスをご確認ください。 | ...Please check your inbox. |
| `error.invalidEmailFormat` | 正しいメールアドレスの形式で... | Please enter a valid email format. |
| `error.linkInvalid` | （`common-error-handling.md` を参照） | (See `common-error-handling.md`) |
| `error.rateLimit` | （`common-error-handling.md` を参照） | (See `common-error-handling.md`) |


---
---

**(以下、元の v1.0 から保持した付録セクション)**

## Appendix A: 本書の目的

本書は、HarmoNetアプリケーションの「ログイン画面」の機能設計を定義する文書である。
AI（Gemini, Claude, GPT）と開発者が共通の認識を持ち、一貫性のあるUI/UXを構築することを目的とする。

## Appendix B: 目次
(※ このセクションはドキュメントの最終FIX時に自動生成または手動更新する)
- 1. 概要
- 2. 画面レイアウト
- 3. UIコンポーネント仕様
- 4. 機能要件
  - 4.1 画面機能
  - 4.2 認証フロー
  - 4.3 メール送信完了画面
- 5. 状態管理
- **6. バリデーションとエラーハンドリング (v1.1 更新)**
  - **6.1 クライアントサイド バリデーション**
  - **6.2 サーバーサイド バリデーション**
  - **6.3 画面固有のエラーハンドリング (UX) (v1.2 更新)**
  - **6.4 共通エラーハンドリング (v1.2 追記)**
- 7. セキュリティ
- 8. パフォーマンス
- 9. 翻訳 (i18n)
- Appendix A: 本書の目的
- Appendix B: 目次
- Appendix C: 改訂履歴

## Appendix C: 改訂履歴

| バージョン | 日付 | 更新者 | 更新内容 |
| --- | --- | --- | --- |
| v1.0 | 2025-10-27 | TKE | 新規作成 |
| v1.1 | 2025-10-28 | Gemini | レート制限、トークン仕様、エラーハンドリングを追記 (4.1.3, 4.2.2, 6.3) |
| **v1.2** | **2025-10-28** | **Gemini** | **`common-error-handling.md` への参照を追記 (1.3)。エラーハンドリング(6.3, 6.4)を共通と固有に分離。** |