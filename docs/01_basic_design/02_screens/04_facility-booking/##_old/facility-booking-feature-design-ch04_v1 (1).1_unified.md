# 施設予約機能 詳細設計書 Chapter 04: 予約制限ルール・検証

**HarmoNet スマートコミュニケーションアプリ**  
**文書ID**: HARMONET-FACILITY-BOOKING-DESIGN-001-CH04  
**バージョン**: v1.1（統一版）  
**最終更新**: 2025年10月29日  
**ステータス**: 承認待ち

---

## 目次
1. [4.1 予約制限ルール](#41-予約制限ルール)  
2. [4.2 バリデーション詳細](#42-バリデーション詳細)  
3. [4.3 排他制御と二重予約防止](#43-排他制御と二重予約防止)  
4. [4.4 同日複数予約の防止](#44-同日複数予約の防止)  
5. [4.5 連続予約の検証](#45-連続予約の検証)  
6. [4.6 予約可能期間の検証](#46-予約可能期間の検証)  
7. [4.7 キャンセルポリシー](#47-キャンセルポリシー)  
8. [4.8 テストケース](#48-テストケース)

---

## 4.1 予約制限ルール

本章では、施設予約における基本制限ルールとその検証・実装方式を定義する。  
制限ルールは公平性・利便性を維持するための基礎仕様であり、MVP版においては下表の内容を実装対象とする。

| 制限項目 | ルール内容 | 検証タイミング | エラーコード |
|-----------|-------------|----------------|--------------|
| 同日複数予約 | 同一ユーザーが同日に複数予約不可 | サーバー側検証 | 422 |
| 連続予約 | 最大3日間まで連続予約可能 | クライアント・サーバー双方 | 422 |
| 予約期限 | 当日から30日先まで予約可能 | 双方 | 422 |
| キャンセル | 利用開始前まで随時可能 | サーバー側検証 | 422 |

各ルールは共通の構造（目的・検証ロジック・実装方式・エラーメッセージ・例外処理）で定義する。

---

## 4.2 バリデーション詳細

### 4.2.1 クライアント側バリデーション

ユーザー入力を即時に検証し、エラーをリアルタイムで通知する。  
主要項目のバリデーションルールを以下に示す。

| 入力項目 | バリデーションルール | エラーメッセージ | 実装方式 |
|-----------|-------------------|----------------|----------|
| 予約日 | 当日〜30日先まで | 「予約は30日先までです」 | 日付選択時 |
| 予約日 | 過去日不可 | 「過去の日付は予約できません」 | 日付選択時 |
| 駐車場所 | 必須選択 | 「駐車場所を選択してください」 | 次へボタン押下時 |
| 車両ナンバー | 数字4桁（任意） | 「数字4桁で入力してください」 | 入力時 |
| 連続予約日数 | 1〜3日 | 「連続予約は最大3日間までです」 | 選択時 |

```javascript
// 予約日バリデーション例
function validateBookingDate(requestedDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const requested = new Date(requestedDate);
  requested.setHours(0, 0, 0, 0);
  const diffDays = Math.floor((requested - today) / (1000 * 60 * 60 * 24));
  if (diffDays < 0) throw new Error('過去の日付は予約できません');
  if (diffDays > 30) throw new Error('予約は30日先までです');
  return true;
}
```

### 4.2.2 サーバー側バリデーション

ビジネスルールに基づき、DBレベルで整合性を保証する。  
代表的なチェックは以下の通り。

| 検証項目 | 概要 | エラーコード |
|-----------|------|---------------|
| 二重予約チェック | 同施設・同日付の予約重複を防止 | 409 |
| 同日複数予約 | 同一ユーザーの同日予約を禁止 | 422 |
| 連続予約チェック | 最大3日までの連続日数を検証 | 422 |
| 予約可能期間 | 当日〜30日先の範囲を確認 | 422 |
| 外部キー整合性 | facility_id 等の存在確認 | 400 |

---

## 4.3 排他制御と二重予約防止

同一時間帯に複数ユーザーが同じ施設を予約しようとする場合、悲観的ロックを用いて整合性を保つ。

```sql
BEGIN TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM bookings
 WHERE facility_id = 3
   AND space_id = 'F3'
   AND booking_date = '2025-11-15'
   AND status = 'confirmed'
 FOR UPDATE;
INSERT INTO bookings (booking_id, user_id, facility_id, space_id, booking_date)
 VALUES ('uuid', 123, 3, 'F3', '2025-11-15');
COMMIT;
```

**理由**: 予約は頻繁ではないため、確実性を優先して悲観的ロックを採用する。

---

## 4.4 同日複数予約の防止

公平性確保のため、同一ユーザーによる同日複数予約を禁止する。

```sql
SELECT COUNT(*) FROM bookings
 WHERE user_id = {user_id}
   AND booking_date = {requested_date}
   AND status = 'confirmed';
```

結果が1件以上の場合、エラー「同日に既に予約があります」を返す。

---

## 4.5 連続予約の検証

同一施設・同一スペースにおいて、連続した日付での予約を可能とするが、3日以内に制限する。

- クライアント：1〜3日の選択肢のみを提供  
- サーバー：各日付の空き状況を一括確認  
- 登録：`booking_group_id` でグループ化し、キャンセル時も一括操作

```sql
INSERT INTO bookings VALUES
  ('uuid-1', 123, 3, 'F3', '2025-11-15', 'confirmed', 'group-abc'),
  ('uuid-2', 123, 3, 'F3', '2025-11-16', 'confirmed', 'group-abc');
```

---

## 4.6 予約可能期間の検証

当日から30日先までを予約対象期間とする。  
連続予約の場合、終了日も30日以内であることを検証。

```javascript
if (diffDays > 30) throw new Error('予約は30日先までです');
```

31日以降の予約はエラーとし、利用者に「期間外で予約できません」と案内する。

---

## 4.7 キャンセルポリシー

- 利用開始前までキャンセル可。  
- 利用開始後はキャンセル不可（自動的に「完了」へ遷移）。  
- 連続予約はグループ単位で一括キャンセル。

```sql
UPDATE bookings
 SET status = 'cancelled', cancelled_at = CURRENT_TIMESTAMP
 WHERE booking_group_id = 'group-abc' AND status = 'confirmed';
```

MVPではキャンセル料金なし。将来的にポイント差引制を検討する。

---

## 4.8 テストケース

### 単体テスト
- ✅ 当日の予約 → 成功  
- ✅ 30日後の予約 → 成功  
- ❌ 過去日の予約 → エラー  
- ❌ 31日後の予約 → エラー

### 統合テスト
- 二重予約：1ユーザーのみ成功、他はエラー  
- 同日複数予約：既存予約日と重複した場合エラー  
- 連続予約：3日間以内は成功、4日以上はエラー

---

## 📖 ナビゲーション

- [⬅️ 前の章: Chapter 03 - 予約フロー・画面構成](facility-booking-feature-design-ch03_v1.0.md)  
- [➡️ 次の章: Chapter 05 - 管理機能](facility-booking-feature-design-ch05_v1.0.md)  
- [📚 目次に戻る](facility-booking-feature-design-ch00-index_v1.0.md)

---
